# 前后端分离项目合并为单体项目方案

## 概述

将当前的前后端分离的 OSS Manager 项目合并为单体项目，实现一个可执行文件包含完整的前后端功能。

## 目标架构

```
OSS Manager Monolith
├── Go Backend (API + Static File Server)
├── Embedded Frontend (静态资源嵌入)
├── Single Binary Deployment
└── Unified Configuration
```

## 实现方案

### 1. 项目结构调整

```
ossmanager/
├── cmd/
│   └── server/
│       └── main.go                 # 单体应用入口
├── internal/
│   ├── api/                       # 原有API代码
│   ├── config/                    # 配置管理
│   ├── embed/                     # 嵌入静态文件
│   └── server/                    # 服务器设置
├── web/                           # 前端源代码
│   ├── build/                     # 构建后的静态文件
│   └── src/                       # 原有前端代码
├── configs/                       # 配置文件
├── deployments/                   # 部署相关
├── go.mod
├── go.sum
├── Makefile                       # 构建脚本
└── README.md
```

### 2. 核心技术方案

#### 2.1 静态资源嵌入

使用 Go 1.16+ 的 `embed` 包将前端构建产物嵌入到二进制文件中：

```go
//go:embed web/build/*
var staticFiles embed.FS
```

#### 2.2 路由分离

- `/api/*` - API 路由
- `/*` - 静态文件服务 + SPA 路由

#### 2.3 构建流程

1. 构建前端项目 → 生成静态文件
2. 嵌入静态文件到 Go 代码
3. 编译 Go 项目 → 生成单一可执行文件

## 实施步骤

### 步骤 1: 项目结构重组

### 步骤 2: 前端构建集成

### 步骤 3: 静态文件服务

### 步骤 4: 配置统一

### 步骤 5: 部署优化

## 优缺点分析

### 优点

1. **部署简化**
   - 单一可执行文件，易于部署和分发
   - 无需额外的静态文件服务器
   - 减少运维复杂度

2. **性能优化**
   - 减少网络请求延迟
   - 静态资源直接从内存服务
   - 更好的缓存策略

3. **开发效率**
   - 统一的构建流程
   - 简化的配置管理
   - 更好的调试体验

### 缺点

1. **灵活性降低**
   - 前后端紧耦合
   - 难以独立扩展
   - 技术栈限制

2. **构建复杂度**
   - 需要同时构建前后端
   - 构建时间可能增加
   - 调试相对复杂

3. **资源使用**
   - 二进制文件体积增大
   - 内存占用可能增加

## 迁移风险评估

### 低风险
- 现有API接口保持不变
- 数据库模型无需修改
- 业务逻辑保持独立

### 中等风险
- 前端路由配置需要调整
- 构建流程需要重新设计
- 开发工作流需要适应

### 高风险
- 静态资源缓存策略
- WebDAV 功能兼容性
- 大文件上传处理

## 实施计划

### 阶段一：准备工作 (1-2天)
- [ ] 项目结构规划
- [ ] 技术方案验证
- [ ] 构建脚本设计

### 阶段二：核心实现 (3-5天)
- [ ] 静态文件嵌入
- [ ] 路由整合
- [ ] 配置统一

### 阶段三：功能验证 (2-3天)
- [ ] 基本功能测试
- [ ] WebDAV 功能验证
- [ ] 性能测试

### 阶段四：优化完善 (2-3天)
- [ ] 错误处理优化
- [ ] 日志系统完善
- [ ] 部署脚本更新

## 技术细节

### 前端构建配置

需要调整前端构建配置以适应嵌入式部署：

1. **路径配置**
   - 相对路径引用
   - 资源路径调整

2. **构建输出**
   - 单一目录输出
   - 文件名优化

3. **缓存策略**
   - 文件指纹
   - 缓存头设置

### 后端路由策略

```go
// API 路由优先级最高
router.PathPrefix("/api/").Handler(apiHandler)

// WebDAV 路由
router.PathPrefix("/webdav/").Handler(webdavHandler)

// 静态文件和 SPA 路由
router.PathPrefix("/").Handler(spaHandler)
```

### 配置管理

统一配置文件格式：

```yaml
server:
  host: "0.0.0.0"
  port: 8080
  mode: "production"

frontend:
  enable_spa: true
  cache_control: "public, max-age=31536000"

database:
  # ... 现有数据库配置

storage:
  # ... 现有存储配置
```

## 回退方案

如果单体化过程中遇到问题，可以通过以下方式回退：

1. **临时方案**
   - 保持原有前后端分离部署
   - 使用反向代理整合

2. **渐进式迁移**
   - 先实现静态文件服务
   - 逐步合并其他功能

3. **混合部署**
   - 单体项目处理 API
   - 独立服务处理静态文件

## 性能优化建议

1. **静态资源优化**
   - Gzip 压缩
   - 适当的缓存头
   - 资源预加载

2. **内存管理**
   - 合理的文件缓存策略
   - 及时释放不需要的资源

3. **并发处理**
   - 异步文件服务
   - 连接池优化

## 监控和日志

1. **性能监控**
   - 响应时间监控
   - 内存使用监控
   - 文件服务性能

2. **日志策略**
   - 统一日志格式
   - 请求链路追踪
   - 错误日志聚合

## 总结

将前后端分离项目合并为单体项目是一个有意义的架构调整，特别适合：

- 中小型团队
- 部署环境受限
- 对运维简化有强需求

通过合理的设计和实现，可以在保持原有功能的基础上，获得更好的部署体验和运维效率。
