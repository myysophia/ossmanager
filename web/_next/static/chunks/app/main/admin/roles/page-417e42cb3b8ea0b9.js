(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[3320],{7161:(e,s,t)=>{"use strict";t.d(s,{HY:()=>r,Hl:()=>i});let i=()=>{console.log("\uD83D\uDD10 认证令牌过期，清除认证信息并重定向到登录页..."),localStorage.removeItem("token"),localStorage.removeItem("user"),localStorage.removeItem("refreshToken"),document.cookie="token=; path=/; expires=Thu, 01 Jan 1970 00:00:00 GMT",window.location.pathname.includes("/auth/login")||(window.location.href="/auth/login")},r=e=>{var s;return e&&"object"==typeof e&&"response"in e&&(null===(s=e.response)||void 0===s?void 0:s.status)===401}},7283:(e,s,t)=>{"use strict";t.d(s,{IW:()=>n,NR:()=>a,QS:()=>r});var i=t(96918);let r={getUsers:async e=>{console.log("UserAPI.getUsers called with params:",e);let s=await i.A.get("/users",{params:e});return console.log("UserAPI.getUsers raw response:",s),s.data},getUser:async e=>(await i.A.get("/users/".concat(e))).data,createUser:async e=>(await i.A.post("/users",e)).data,updateUser:async(e,s)=>(await i.A.put("/users/".concat(e),s)).data,deleteUser:async e=>{await i.A.delete("/users/".concat(e))}},a={getRoles:async e=>{try{let a=(await i.A.get("/roles",{params:e})).data;if(a&&a.data&&Array.isArray(a.data.items)){let e=a.data.items.map(e=>{var s,t,i;return{id:e.id,name:null!==(s=e.name)&&void 0!==s?s:"",description:null!==(t=e.description)&&void 0!==t?t:"",permissions:Array.isArray(e.permissions)?e.permissions:[],created_at:null!==(i=e.created_at)&&void 0!==i?i:"",...e}});return{roles:e,total:e.length}}if(Array.isArray(a)){let e=a.map(e=>{var s,t,i;return{id:e.id,name:null!==(s=e.name)&&void 0!==s?s:"",description:null!==(t=e.description)&&void 0!==t?t:"",permissions:Array.isArray(e.permissions)?e.permissions:[],created_at:null!==(i=e.created_at)&&void 0!==i?i:"",...e}});return{roles:e,total:e.length}}if(a&&"object"==typeof a&&a.id){var s,t,r;return{roles:[{id:a.id,name:null!==(s=a.name)&&void 0!==s?s:"",description:null!==(t=a.description)&&void 0!==t?t:"",permissions:Array.isArray(a.permissions)?a.permissions:[],created_at:null!==(r=a.created_at)&&void 0!==r?r:"",...a}],total:1}}return{roles:[],total:0}}catch(e){return{roles:[],total:0}}},getRole:async e=>(await i.A.get("/roles/".concat(e))).data,createRole:async e=>(await i.A.post("/roles",e)).data,updateRole:async(e,s)=>(await i.A.put("/roles/".concat(e),s)).data,deleteRole:async e=>{await i.A.delete("/roles/".concat(e))},getRegionBucketMappings:async e=>(await i.A.get("/region-bucket-mappings",{params:e})).data,getRoleRegionBucketAccess:async e=>(await i.A.get("/roles/".concat(e,"/bucket-access"))).data,updateRoleRegionBucketAccess:async(e,s)=>{await i.A.put("/roles/".concat(e,"/bucket-access"),s)},deleteRoleRegionBucketAccess:async(e,s)=>{await i.A.delete("/roles/".concat(e,"/accessible-buckets/").concat(s))}},n={getPermissions:async e=>{try{let s=await i.A.get("/permissions",{params:e});if(console.log("PermissionAPI.getPermissions response:",s),console.log("PermissionAPI.getPermissions response.data:",s.data),s.data&&s.data.items)return console.log("PermissionAPI.getPermissions response.data.items:",s.data.items),{permissions:s.data.items,total:s.data.total};if(Array.isArray(s.data))return{permissions:s.data,total:s.data.length};return{permissions:[],total:0}}catch(e){throw console.error("PermissionAPI.getPermissions error:",e),e}},getPermission:async e=>(await i.A.get("/permissions/".concat(e))).data,createPermission:async e=>(await i.A.post("/permissions",e)).data,updatePermission:async(e,s)=>(await i.A.put("/permissions/".concat(e),s)).data,deletePermission:async e=>{await i.A.delete("/permissions/".concat(e))}}},11649:(e,s,t)=>{"use strict";t.d(s,{D:()=>c});var i=t(95155),r=t(78038),a=t(92622),n=t(30044),l=t(17891),o=t(47415);let c=(0,n.R)(function(e,s){let t=(0,l.V)("Heading",e),{className:n,...c}=(0,r.M)(e);return(0,i.jsx)(o.B.h2,{ref:s,className:(0,a.cx)("chakra-heading",e.className),...c,__css:t})});c.displayName="Heading"},26584:(e,s,t)=>{"use strict";t.d(s,{S:()=>w});var i=t(95155),r=t(78038),a=t(72401),n=t(85720),l=t(92622),o=t(13380),c=t(12115);let[d,u]=(0,t(61214).q)({name:"CheckboxGroupContext",strict:!1});var h=t(47415);function m(e){return(0,i.jsx)(h.B.svg,{width:"1.2em",viewBox:"0 0 12 10",style:{fill:"none",strokeWidth:2,stroke:"currentColor",strokeDasharray:16},...e,children:(0,i.jsx)("polyline",{points:"1.5 6 4.5 9 10.5 1"})})}function p(e){return(0,i.jsx)(h.B.svg,{width:"1.2em",viewBox:"0 0 24 24",style:{stroke:"currentColor",strokeWidth:4},...e,children:(0,i.jsx)("line",{x1:"21",x2:"3",y1:"12",y2:"12"})})}function x(e){let{isIndeterminate:s,isChecked:t,...r}=e;return t||s?(0,i.jsx)(h.B.div,{style:{display:"flex",alignItems:"center",justifyContent:"center",height:"100%"},children:(0,i.jsx)(s?p:m,{...r})}):null}var g=t(1106),j=t(30044),f=t(17891);let v={display:"inline-flex",alignItems:"center",justifyContent:"center",verticalAlign:"top",userSelect:"none",flexShrink:0},y={cursor:"pointer",display:"inline-flex",alignItems:"center",verticalAlign:"top",position:"relative"},k=(0,o.i7)({from:{opacity:0,strokeDashoffset:16,transform:"scale(0.95)"},to:{opacity:1,strokeDashoffset:0,transform:"scale(1)"}}),b=(0,o.i7)({from:{opacity:0},to:{opacity:1}}),C=(0,o.i7)({from:{transform:"scaleX(0.65)"},to:{transform:"scaleX(1)"}}),w=(0,j.R)(function(e,s){let t=u(),o={...t,...e},d=(0,f.o)("Checkbox",o),m=(0,r.M)(e),{spacing:p="0.5rem",className:j,children:w,iconColor:S,iconSize:A,icon:_=(0,i.jsx)(x,{}),isChecked:R,isDisabled:L=null==t?void 0:t.isDisabled,onChange:T,inputProps:I,...N}=m,M=R;(null==t?void 0:t.value)&&m.value&&(M=t.value.includes(m.value));let z=T;(null==t?void 0:t.onChange)&&m.value&&(z=(0,a.O)(t.onChange,T));let{state:E,getInputProps:P,getCheckboxProps:B,getLabelProps:O,getRootProps:W}=(0,g.v)({...N,isDisabled:L,isChecked:M,onChange:z}),D=function(e){let[s,t]=(0,c.useState)(e),[i,r]=(0,c.useState)(!1);return e!==s&&(r(!0),t(e)),i}(E.isChecked),H=(0,c.useMemo)(()=>({animation:D?E.isIndeterminate?"".concat(b," 20ms linear, ").concat(C," 200ms linear"):"".concat(k," 200ms linear"):void 0,...d.icon,...(0,n.o)({fontSize:A,color:S})}),[S,A,D,E.isIndeterminate,d.icon]),V=(0,c.cloneElement)(_,{__css:H,isIndeterminate:E.isIndeterminate,isChecked:E.isChecked});return(0,i.jsxs)(h.B.label,{__css:{...y,...d.container},className:(0,l.cx)("chakra-checkbox",j),...W(),children:[(0,i.jsx)("input",{className:"chakra-checkbox__input",...P(I,s)}),(0,i.jsx)(h.B.span,{__css:{...v,...d.control},className:"chakra-checkbox__control",...B(),children:V}),w&&(0,i.jsx)(h.B.span,{className:"chakra-checkbox__label",...O(),__css:{marginStart:p,...d.label},children:w})]})});w.displayName="Checkbox"},29358:(e,s,t)=>{"use strict";t.d(s,{q:()=>r});var i=t(95155);let r=(0,t(24345).w)({displayName:"EditIcon",path:(0,i.jsxs)("g",{fill:"none",stroke:"currentColor",strokeLinecap:"round",strokeWidth:"2",children:[(0,i.jsx)("path",{d:"M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"}),(0,i.jsx)("path",{d:"M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"})]})})},32643:(e,s,t)=>{"use strict";t.d(s,{d:()=>r});var i=t(95155);let r=(0,t(24345).w)({displayName:"DeleteIcon",path:(0,i.jsx)("g",{fill:"currentColor",children:(0,i.jsx)("path",{d:"M19.452 7.5H4.547a.5.5 0 00-.5.545l1.287 14.136A2 2 0 007.326 24h9.347a2 2 0 001.992-1.819L19.95 8.045a.5.5 0 00-.129-.382.5.5 0 00-.369-.163zm-9.2 13a.75.75 0 01-1.5 0v-9a.75.75 0 011.5 0zm5 0a.75.75 0 01-1.5 0v-9a.75.75 0 011.5 0zM22 4h-4.75a.25.25 0 01-.25-.25V2.5A2.5 2.5 0 0014.5 0h-5A2.5 2.5 0 007 2.5v1.25a.25.25 0 01-.25.25H2a1 1 0 000 2h20a1 1 0 000-2zM9 3.75V2.5a.5.5 0 01.5-.5h5a.5.5 0 01.5.5v1.25a.25.25 0 01-.25.25h-5.5A.25.25 0 019 3.75z"})})})},35695:(e,s,t)=>{"use strict";var i=t(18999);t.o(i,"usePathname")&&t.d(s,{usePathname:function(){return i.usePathname}}),t.o(i,"useRouter")&&t.d(s,{useRouter:function(){return i.useRouter}})},43508:(e,s,t)=>{"use strict";t.d(s,{c:()=>c});var i=t(95155),r=t(78038),a=t(92622),n=t(30044),l=t(17891),o=t(47415);let c=(0,n.R)(function(e,s){let{borderLeftWidth:t,borderBottomWidth:n,borderTopWidth:c,borderRightWidth:d,borderWidth:u,borderStyle:h,borderColor:m,...p}=(0,l.V)("Divider",e),{className:x,orientation:g="horizontal",__css:j,...f}=(0,r.M)(e);return(0,i.jsx)(o.B.hr,{ref:s,"aria-orientation":g,...f,__css:{...p,border:"0",borderColor:m,borderStyle:h,...{vertical:{borderLeftWidth:t||d||u||"1px",height:"100%"},horizontal:{borderBottomWidth:n||c||u||"1px",width:"100%"}}[g],...j},className:(0,a.cx)("chakra-divider",x)})});c.displayName="Divider"},52104:(e,s,t)=>{Promise.resolve().then(t.bind(t,55692))},55692:(e,s,t)=>{"use strict";t.r(s),t.d(s,{default:()=>ei});var i=t(95155),r=t(12115),a=t(23006),n=t(52017),l=t(77700),o=t(58727),c=t(42066),d=t(49747),u=t(33636),h=t(77978),m=t(37824),p=t(83382),x=t(47272),g=t(76122),j=t(66080),f=t(24710),v=t(80436),y=t(39376),k=t(58670),b=t(84002),C=t(91985),w=t(29358),S=t(24345);let A=(0,S.w)({d:"M19.5,9.5h-.75V6.75a6.75,6.75,0,0,0-13.5,0V9.5H4.5a2,2,0,0,0-2,2V22a2,2,0,0,0,2,2h15a2,2,0,0,0,2-2V11.5A2,2,0,0,0,19.5,9.5Zm-9.5,6a2,2,0,1,1,3,1.723V19.5a1,1,0,0,1-2,0V17.223A1.994,1.994,0,0,1,10,15.5ZM7.75,6.75a4.25,4.25,0,0,1,8.5,0V9a.5.5,0,0,1-.5.5H8.25a.5.5,0,0,1-.5-.5Z",displayName:"LockIcon"}),_=(0,S.w)({viewBox:"0 0 14 14",d:"M14,7.77 L14,6.17 L12.06,5.53 L11.61,4.44 L12.49,2.6 L11.36,1.47 L9.55,2.38 L8.46,1.93 L7.77,0.01 L6.17,0.01 L5.54,1.95 L4.43,2.4 L2.59,1.52 L1.46,2.65 L2.37,4.46 L1.92,5.55 L0,6.23 L0,7.82 L1.94,8.46 L2.39,9.55 L1.51,11.39 L2.64,12.52 L4.45,11.61 L5.54,12.06 L6.23,13.98 L7.82,13.98 L8.45,12.04 L9.56,11.59 L11.4,12.47 L12.53,11.34 L11.61,9.53 L12.08,8.44 L14,7.75 L14,7.77 Z M7,10 C5.34,10 4,8.66 4,7 C4,5.34 5.34,4 7,4 C8.66,4 10,5.34 10,7 C10,8.66 8.66,10 7,10 Z",displayName:"SettingsIcon"});var R=t(32643),L=t(7283),T=t(89342),I=t(25442),N=t(64688),M=t(61549),z=t(27104),E=t(19782),P=t(5643),B=t(75569),O=t(26418),W=t(79175),D=t(88254),H=t(26584),V=t(49174);function $(e){let{isOpen:s,onClose:t,role:n,onSuccess:o}=e,[c,d]=(0,r.useState)(""),[m,p]=(0,r.useState)(""),[x,g]=(0,r.useState)([]),[j,f]=(0,r.useState)([]),[v,y]=(0,r.useState)(!1),b=(0,a.d)();(0,r.useEffect)(()=>{if(n){var e;d(n.name),p(n.description||""),f((null===(e=n.permissions)||void 0===e?void 0:e.map(e=>e.id))||[])}else d(""),p(""),f([])},[n]),(0,r.useEffect)(()=>{let e=async()=>{try{let e=await L.IW.getPermissions({page:1,limit:100});g(e.permissions)}catch(e){b({title:"获取权限列表失败",description:e instanceof Error?e.message:"未知错误",status:"error",duration:3e3,isClosable:!0})}};s&&e()},[s]);let C=async()=>{if(!c){b({title:"请填写角色名称",status:"error",duration:3e3,isClosable:!0});return}try{y(!0),n?(await L.NR.updateRole(n.id,{name:c,description:m,permission_ids:j}),b({title:"更新成功",status:"success",duration:3e3,isClosable:!0})):(await L.NR.createRole({name:c,description:m,permission_ids:j}),b({title:"创建成功",status:"success",duration:3e3,isClosable:!0})),o(),t()}catch(e){b({title:n?"更新失败":"创建失败",description:e instanceof Error?e.message:"未知错误",status:"error",duration:3e3,isClosable:!0})}finally{y(!1)}},w=(e,s)=>{s?f([...j,e]):f(j.filter(s=>s!==e))},S=(null!=x?x:[]).reduce((e,s)=>{let t=s.resource;return e[t]||(e[t]=[]),e[t].push(s),e},{});return(0,i.jsxs)(I.aF,{isOpen:s,onClose:t,size:"xl",children:[(0,i.jsx)(N.m,{}),(0,i.jsxs)(M.$,{children:[(0,i.jsx)(z.r,{children:n?"编辑角色":"新建角色"}),(0,i.jsx)(E.s,{}),(0,i.jsx)(P.c,{children:(0,i.jsxs)(B.T,{spacing:4,children:[(0,i.jsxs)(O.MJ,{isRequired:!0,children:[(0,i.jsx)(W.l,{children:"角色名称"}),(0,i.jsx)(u.p,{value:c,onChange:e=>d(e.target.value),placeholder:"请输入角色名称"})]}),(0,i.jsxs)(O.MJ,{children:[(0,i.jsx)(W.l,{children:"描述"}),(0,i.jsx)(D.T,{value:m,onChange:e=>p(e.target.value),placeholder:"请输入角色描述"})]}),(0,i.jsxs)(O.MJ,{children:[(0,i.jsx)(W.l,{children:"权限"}),(0,i.jsx)(l.a,{maxH:"300px",overflowY:"auto",borderWidth:1,borderRadius:"md",p:4,children:Object.entries(S).map(e=>{let[s,t]=e;return(0,i.jsxs)(l.a,{mb:4,children:[(0,i.jsx)(k.E,{fontWeight:"bold",mb:2,children:s}),(0,i.jsx)(B.T,{align:"start",spacing:2,children:t.map(e=>(0,i.jsx)(H.S,{isChecked:j.includes(e.id),onChange:s=>w(e.id,s.target.checked),children:e.name},e.id))})]},s)})})]})]})}),(0,i.jsxs)(V.j,{children:[(0,i.jsx)(h.$,{variant:"ghost",mr:3,onClick:t,children:"取消"}),(0,i.jsx)(h.$,{colorScheme:"blue",onClick:C,isLoading:v,children:n?"更新":"创建"})]})]})]})}var F=t(11649),U=t(59108),q=t(92622),J=t(30044),Z=t(47415);let X=(0,J.R)((e,s)=>{var t;let{overflow:r,overflowX:a,className:n,...l}=e;return(0,i.jsx)(Z.B.div,{ref:s,className:(0,q.cx)("chakra-table__container",n),...l,__css:{display:"block",whiteSpace:"nowrap",WebkitOverflowScrolling:"touch",overflowX:null!==(t=null!=r?r:a)&&void 0!==t?t:"auto",overflowY:"hidden",maxWidth:"100%"}})});var Y=t(84492);let G=(0,S.w)({d:"M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z",displayName:"ChevronRightIcon"}),K=(0,S.w)({d:"M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z",displayName:"ChevronLeftIcon"});function Q(e){let{isOpen:s,onClose:t,roleId:n,roleName:c,onSuccess:d}=e;console.log("RegionBucketAccessForm Props:",{isOpen:s,roleId:n,roleName:c});let v=(0,a.d)(),[y,b]=(0,r.useState)([]),[C,w]=(0,r.useState)([]),[S,A]=(0,r.useState)(1),[_]=(0,r.useState)(10),[R,T]=(0,r.useState)(""),[O,W]=(0,r.useState)(!1),[D,$]=(0,r.useState)([]),[q,J]=(0,r.useState)(!1),[Z,Q]=(0,r.useState)([]),[ee,es]=(0,r.useState)([]),[et,ei]=(0,r.useState)(!1),er=(0,r.useCallback)(async()=>{if(!n){console.warn("roleId is undefined or null in fetchAllMappings, skipping.");return}W(!0);try{var e,s;let t=await L.NR.getRegionBucketMappings({page:1,limit:1e3}),i=null!==(s=null==t?void 0:null===(e=t.data)||void 0===e?void 0:e.items)&&void 0!==s?s:[];b(i),w(i),console.log("Initial data loaded:",i)}catch(e){console.error("Failed to fetch all mappings:",e),v({title:"加载所有地域-桶失败",description:e.message||"请检查网络或后端服务。",status:"error",duration:3e3})}finally{W(!1)}},[n,v]),ea=(0,r.useCallback)(async()=>{if(console.log("Fetching assigned mappings for roleId:",n),!n){console.warn("roleId is undefined or null in fetchAssignedMappings, skipping.");return}J(!0);try{let e=await L.NR.getRoleRegionBucketAccess(n);console.log("Raw API Response (Assigned Mappings):",e);let s=[];e&&(e.id&&e.region_code&&e.bucket_name?s=[e]:Array.isArray(e)&&(s=e)),console.log("Processed assigned mappings:",s),$(s)}catch(e){console.error("Failed to fetch assigned mappings:",e),v({title:"加载已分配地域-桶失败",description:e.message||"请检查网络或后端服务。",status:"error",duration:3e3})}finally{J(!1)}},[n,v]);(0,r.useEffect)(()=>{if(console.log("useEffect triggered. isOpen:",s,"roleId:",n),!s||!n){console.log("Modal not open or roleId missing, returning early from useEffect."),b([]),A(1),w([]),$([]),Q([]),es([]),W(!1),J(!1),ei(!1);return}console.log("Modal opened and roleId is valid. Triggering initial data fetch."),er(),ea()},[s,n]),(0,r.useEffect)(()=>{s&&n&&er()},[S,R,s,n,er]);let en=(0,r.useMemo)(()=>new Set(D.map(e=>e.id)),[D]),el=(0,r.useCallback)(e=>{T(e),A(1)},[]);(0,r.useEffect)(()=>{if(R){let e=R.toLowerCase().trim(),s=y.filter(s=>s.bucket_name.toLowerCase().includes(e)||s.region_code.toLowerCase().includes(e));console.log("Filter changed, new filtered results:",s),w(s)}else w(y)},[R,y]);let eo=(0,r.useMemo)(()=>{console.log("Computing leftList with filteredMappings:",C);let e=C.filter(e=>!en.has(e.id));return console.log("Filtered leftList:",e),e},[C,en]),ec=e=>{Q(s=>s.includes(e)?s.filter(s=>s!==e):[...s,e])},ed=e=>{es(s=>s.includes(e)?s.filter(s=>s!==e):[...s,e])},eu=Math.ceil(eo.length/_),eh=(0,r.useMemo)(()=>{console.log("Computing paginatedMappings with leftList:",eo);let e=(S-1)*_,s=eo.slice(e,e+_);return console.log("Paginated results:",s),s},[eo,S,_]),em=async()=>{ei(!0);try{let e=D.map(e=>e.id);await L.NR.updateRoleRegionBucketAccess(n,{region_bucket_mapping_ids:e}),v({title:"保存成功",status:"success",duration:3e3,isClosable:!0}),d&&d(),t()}catch(t){var e,s;console.error("Failed to save mappings:",t),v({title:"保存失败",description:(null===(s=t.response)||void 0===s?void 0:null===(e=s.data)||void 0===e?void 0:e.message)||"保存失败，请重试。",status:"error",duration:5e3,isClosable:!0})}finally{ei(!1)}};return(0,r.useEffect)(()=>{let e=!0;return s&&n&&(async()=>{e&&await er()})(),()=>{e=!1}},[s,n]),(0,r.useEffect)(()=>{s||(b([]),w([]),A(1),T(""),$([]),Q([]),es([]),W(!1),J(!1),ei(!1))},[s]),(0,i.jsxs)(I.aF,{isOpen:s,onClose:t,size:"6xl",closeOnOverlayClick:!1,children:[" ",(0,i.jsx)(N.m,{}),(0,i.jsxs)(M.$,{children:[(0,i.jsx)(z.r,{children:(0,i.jsxs)(F.D,{size:"md",children:["地域-桶访问权限分配 - ",c]})}),(0,i.jsx)(E.s,{}),(0,i.jsx)(P.c,{children:(0,i.jsxs)(U.s,{direction:{base:"column",md:"row"},gap:6,children:[" ",(0,i.jsxs)(l.a,{flex:1,borderWidth:"1px",borderRadius:"lg",p:4,children:[(0,i.jsxs)(o.z,{mb:4,children:[(0,i.jsx)(u.p,{placeholder:"按桶名称或地域筛选...",value:R,onChange:e=>el(e.target.value),size:"md"}),(0,i.jsx)(h.$,{size:"md",onClick:()=>{$(e=>{let s=eo.filter(s=>!e.some(e=>e.id===s.id));return[...e,...s]}),Q([])},isDisabled:0===eo.length||O,children:"全部添加"})]}),(0,i.jsxs)(X,{maxH:"400px",overflowY:"auto",children:[" ",(0,i.jsxs)(m.X,{variant:"simple",size:"sm",children:[(0,i.jsx)(p.d,{children:(0,i.jsxs)(x.Tr,{children:[(0,i.jsx)(g.Th,{w:"50px",children:(0,i.jsx)(H.S,{isChecked:Z.length>0&&Z.length===eh.length,onChange:e=>{e.target.checked?Q(eo.map(e=>e.id)):Q([])}})}),(0,i.jsx)(g.Th,{children:"地域"}),(0,i.jsx)(g.Th,{children:"桶名称"})]})}),(0,i.jsx)(j.N,{children:O?(0,i.jsx)(x.Tr,{children:(0,i.jsx)(f.Td,{colSpan:3,textAlign:"center",children:(0,i.jsx)(Y.y,{size:"sm",mt:4})})}):0===eh.length?(0,i.jsx)(x.Tr,{children:(0,i.jsx)(f.Td,{colSpan:3,textAlign:"center",children:(0,i.jsx)(k.E,{py:4,children:"无可分配地域-桶"})})}):eh.map(e=>(0,i.jsxs)(x.Tr,{children:[(0,i.jsx)(f.Td,{children:(0,i.jsx)(H.S,{isChecked:Z.includes(e.id),onChange:()=>ec(e.id)})}),(0,i.jsx)(f.Td,{children:e.region_code}),(0,i.jsx)(f.Td,{children:e.bucket_name})]},e.id))})]})]}),(0,i.jsxs)(U.s,{justifyContent:"space-between",alignItems:"center",mt:4,children:[(0,i.jsxs)(k.E,{fontSize:"sm",children:["共 ",eo.length," 条，第 ",S,"/",eu," 页"]}),(0,i.jsxs)(o.z,{children:[(0,i.jsx)(h.$,{size:"sm",onClick:()=>A(e=>Math.max(1,e-1)),isDisabled:1===S||O,children:"上一页"}),(0,i.jsx)(h.$,{size:"sm",onClick:()=>A(e=>Math.min(eu,e+1)),isDisabled:S===eu||O,children:"下一页"})]})]})]}),(0,i.jsxs)(B.T,{justify:"center",align:"center",minW:"120px",py:4,spacing:4,children:[(0,i.jsx)(h.$,{rightIcon:(0,i.jsx)(G,{}),onClick:()=>{let e=eo.filter(e=>Z.includes(e.id));$(s=>{let t=e.filter(e=>!s.some(s=>s.id===e.id));return[...s,...t]}),Q([])},isDisabled:0===Z.length,size:"md",colorScheme:"blue",children:"添加"}),(0,i.jsx)(h.$,{leftIcon:(0,i.jsx)(K,{}),onClick:()=>{$(e=>e.filter(e=>!ee.includes(e.id))),es([])},isDisabled:0===ee.length,size:"md",colorScheme:"red",children:"移除"})]}),(0,i.jsxs)(l.a,{flex:1,borderWidth:"1px",borderRadius:"lg",p:4,children:[(0,i.jsxs)(o.z,{mb:4,justifyContent:"space-between",children:[(0,i.jsxs)(F.D,{size:"md",children:["已分配给 ",c," 的地域-桶"]}),(0,i.jsx)(h.$,{size:"md",onClick:()=>{$([]),es([])},isDisabled:0===D.length||q,colorScheme:"red",children:"全部移除"})]}),(0,i.jsx)(X,{maxH:"400px",overflowY:"auto",children:(0,i.jsxs)(m.X,{variant:"simple",size:"sm",children:[(0,i.jsx)(p.d,{children:(0,i.jsxs)(x.Tr,{children:[(0,i.jsx)(g.Th,{w:"50px",children:(0,i.jsx)(H.S,{isChecked:ee.length>0&&ee.length===D.length,onChange:e=>{e.target.checked?es(D.map(e=>e.id)):es([])}})}),(0,i.jsx)(g.Th,{children:"地域"}),(0,i.jsx)(g.Th,{children:"桶名称"})]})}),(0,i.jsx)(j.N,{children:q?(0,i.jsx)(x.Tr,{children:(0,i.jsx)(f.Td,{colSpan:3,textAlign:"center",children:(0,i.jsx)(Y.y,{size:"sm",mt:4})})}):0===D.length?(0,i.jsx)(x.Tr,{children:(0,i.jsx)(f.Td,{colSpan:3,textAlign:"center",children:(0,i.jsx)(k.E,{py:4,children:"无已分配地域-桶"})})}):D.map(e=>(0,i.jsxs)(x.Tr,{children:[(0,i.jsx)(f.Td,{children:(0,i.jsx)(H.S,{isChecked:ee.includes(e.id),onChange:()=>ed(e.id)})}),(0,i.jsx)(f.Td,{children:e.region_code}),(0,i.jsx)(f.Td,{children:e.bucket_name})]},e.id))})]})})]})]})}),(0,i.jsx)(V.j,{children:(0,i.jsxs)(o.z,{w:"100%",justify:"flex-end",children:[(0,i.jsx)(h.$,{variant:"outline",onClick:t,isDisabled:et,children:"取消"}),(0,i.jsx)(h.$,{colorScheme:"blue",onClick:em,isLoading:et,children:"保存"})]})})]})]})}var ee=t(43508);function es(e){let{isOpen:s,onClose:t,role:n,onSuccess:o}=e,[c,d]=(0,r.useState)([]),[u,m]=(0,r.useState)([]),[p,x]=(0,r.useState)(!1),g=(0,a.d)();(0,r.useEffect)(()=>{s&&j()},[s,n]);let j=async()=>{try{var e;x(!0);let s=await L.IW.getPermissions({page:1,limit:100});console.log("获取到的权限数据:",s),d(s.permissions),console.log("设置后的 permissions 状态:",s.permissions);let t=await L.NR.getRole(n.id);console.log("获取到的角色权限数据:",t),m((null===(e=t.permissions)||void 0===e?void 0:e.map(e=>e.id))||[])}catch(e){console.error("获取数据失败:",e),g({title:"获取数据失败",description:e instanceof Error?e.message:"未知错误",status:"error",duration:3e3,isClosable:!0})}finally{x(!1)}},f=(e,s)=>{s?m([...u,e]):m(u.filter(s=>s!==e))},v=async()=>{try{x(!0),await L.NR.updateRole(n.id,{name:n.name,description:n.description,permission_ids:u}),g({title:"更新成功",status:"success",duration:3e3,isClosable:!0}),o(),t()}catch(e){g({title:"更新失败",description:e instanceof Error?e.message:"未知错误",status:"error",duration:3e3,isClosable:!0})}finally{x(!1)}},y=c.reduce((e,s)=>{let t=s.resource;return e[t]||(e[t]=[]),e[t].push(s),e},{});return console.log("计算后的 groupedPermissions:",y),console.log("当前 permissions 状态:",c),console.log("当前 selectedPermissions 状态:",u),(0,i.jsxs)(I.aF,{isOpen:s,onClose:t,size:"xl",children:[(0,i.jsx)(N.m,{}),(0,i.jsxs)(M.$,{children:[(0,i.jsxs)(z.r,{children:["角色权限管理 - ",n.name]}),(0,i.jsx)(E.s,{}),(0,i.jsx)(P.c,{children:(0,i.jsx)(B.T,{spacing:4,children:(0,i.jsxs)(O.MJ,{children:[(0,i.jsx)(W.l,{children:"权限列表"}),(0,i.jsx)(l.a,{maxH:"400px",overflowY:"auto",borderWidth:1,borderRadius:"md",p:4,children:p?(0,i.jsx)(k.E,{children:"加载中..."}):0===Object.keys(y).length?(0,i.jsx)(k.E,{children:"暂无权限数据"}):Object.entries(y).map(e=>{let[s,t]=e;return(0,i.jsxs)(l.a,{mb:4,children:[(0,i.jsx)(k.E,{fontWeight:"bold",mb:2,children:s}),(0,i.jsx)(B.T,{align:"start",spacing:2,children:t.map(e=>(0,i.jsx)(H.S,{isChecked:u.includes(e.id),onChange:s=>f(e.id,s.target.checked),children:(0,i.jsxs)(l.a,{children:[(0,i.jsx)(k.E,{fontWeight:"medium",children:e.name}),e.description&&(0,i.jsx)(k.E,{fontSize:"sm",color:"gray.500",children:e.description})]})},e.id))}),(0,i.jsx)(ee.c,{my:2})]},s)})})]})})}),(0,i.jsxs)(V.j,{children:[(0,i.jsx)(h.$,{variant:"ghost",mr:3,onClick:t,children:"取消"}),(0,i.jsx)(h.$,{colorScheme:"blue",onClick:v,isLoading:p,children:"保存"})]})]})]})}function et(){let[e,s]=(0,r.useState)([]),[t,S]=(0,r.useState)(0),[T,I]=(0,r.useState)(1),[N,M]=(0,r.useState)(10),[z,E]=(0,r.useState)(""),[P,B]=(0,r.useState)(!1),O=(0,a.d)(),{isOpen:W,onOpen:D,onClose:H}=(0,n.j)(),[V,F]=(0,r.useState)(null),{isOpen:U,onOpen:q,onClose:J}=(0,n.j)(),{isOpen:Z,onOpen:X,onClose:Y}=(0,n.j)(),G=async()=>{try{B(!0);let e=await L.NR.getRoles({page:T,limit:N,search:z||void 0});s(e.roles),S(e.total)}catch(e){O({title:"获取角色列表失败",description:e instanceof Error?e.message:"未知错误",status:"error",duration:3e3,isClosable:!0})}finally{B(!1)}};(0,r.useEffect)(()=>{G()},[T,N,z]);let K=e=>{E(e),I(1)},ee=e=>{F(e),D()},et=e=>{F(e),q()},ei=e=>{F(e),X()},er=async e=>{if(confirm("确定要删除该角色吗？"))try{await L.NR.deleteRole(e),O({title:"删除成功",status:"success",duration:3e3,isClosable:!0}),G()}catch(e){O({title:"删除失败",description:e instanceof Error?e.message:"未知错误",status:"error",duration:3e3,isClosable:!0})}},ea=Math.ceil(t/N),en=T>1,el=T<ea;return(0,i.jsxs)(l.a,{p:4,children:[(0,i.jsxs)(o.z,{mb:4,justify:"space-between",children:[(0,i.jsxs)(c.M,{maxW:"300px",children:[(0,i.jsx)(d.W,{pointerEvents:"none",children:(0,i.jsx)(b.W,{color:"gray.300"})}),(0,i.jsx)(u.p,{placeholder:"搜索角色...",value:z,onChange:e=>K(e.target.value)})]}),(0,i.jsx)(h.$,{leftIcon:(0,i.jsx)(C.R,{}),colorScheme:"blue",onClick:()=>{F(null),D()},children:"新建角色"})]}),(0,i.jsxs)(m.X,{variant:"simple",children:[(0,i.jsx)(p.d,{children:(0,i.jsxs)(x.Tr,{children:[(0,i.jsx)(g.Th,{children:"角色名称"}),(0,i.jsx)(g.Th,{children:"描述"}),(0,i.jsx)(g.Th,{children:"权限数量"}),(0,i.jsx)(g.Th,{children:"创建时间"}),(0,i.jsx)(g.Th,{children:"操作"})]})}),(0,i.jsx)(j.N,{children:e.map(e=>{var s;return(0,i.jsxs)(x.Tr,{children:[(0,i.jsx)(f.Td,{children:e.name}),(0,i.jsx)(f.Td,{children:e.description||"-"}),(0,i.jsx)(f.Td,{children:(0,i.jsx)(v.E,{colorScheme:"blue",children:(null===(s=e.permissions)||void 0===s?void 0:s.length)||0})}),(0,i.jsx)(f.Td,{children:new Date(e.created_at).toLocaleString()}),(0,i.jsx)(f.Td,{children:(0,i.jsxs)(o.z,{spacing:2,children:[(0,i.jsx)(y.K,{"aria-label":"编辑角色",icon:(0,i.jsx)(w.q,{}),size:"sm",onClick:()=>ee(e)}),(0,i.jsx)(y.K,{"aria-label":"权限管理",icon:(0,i.jsx)(A,{}),size:"sm",colorScheme:"teal",onClick:()=>ei(e)}),(0,i.jsx)(y.K,{"aria-label":"地域-桶访问权限",icon:(0,i.jsx)(_,{}),size:"sm",colorScheme:"purple",onClick:()=>et(e)}),(0,i.jsx)(y.K,{"aria-label":"删除角色",icon:(0,i.jsx)(R.d,{}),size:"sm",colorScheme:"red",onClick:()=>er(e.id)})]})})]},e.id)})})]}),(0,i.jsxs)(o.z,{justify:"space-between",mt:4,children:[(0,i.jsxs)(k.E,{children:["第 ",T," 页，共 ",ea," 页"]}),(0,i.jsxs)(o.z,{children:[(0,i.jsx)(h.$,{size:"sm",onClick:()=>I(T-1),isDisabled:!en,children:"上一页"}),(0,i.jsx)(h.$,{size:"sm",onClick:()=>I(T+1),isDisabled:!el,children:"下一页"})]})]}),(0,i.jsx)($,{isOpen:W,onClose:H,role:V,onSuccess:G}),V&&(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(Q,{isOpen:U,onClose:J,roleId:V.id,roleName:V.name,onSuccess:G}),(0,i.jsx)(es,{isOpen:Z,onClose:Y,role:V,onSuccess:G})]})]})}function ei(){return(0,i.jsx)(T.O,{requireManager:!0,children:(0,i.jsx)(et,{})})}},58670:(e,s,t)=>{"use strict";t.d(s,{E:()=>d});var i=t(95155),r=t(78038),a=t(85720),n=t(92622),l=t(30044),o=t(17891),c=t(47415);let d=(0,l.R)(function(e,s){let t=(0,o.V)("Text",e),{className:l,align:d,decoration:u,casing:h,...m}=(0,r.M)(e),p=(0,a.o)({textAlign:e.align,textDecoration:e.decoration,textTransform:e.casing});return(0,i.jsx)(c.B.p,{ref:s,className:(0,n.cx)("chakra-text",e.className),...p,...m,__css:t})});d.displayName="Text"},59108:(e,s,t)=>{"use strict";t.d(s,{s:()=>n});var i=t(95155),r=t(30044),a=t(47415);let n=(0,r.R)(function(e,s){let{direction:t,align:r,justify:n,wrap:l,basis:o,grow:c,shrink:d,...u}=e;return(0,i.jsx)(a.B.div,{ref:s,__css:{display:"flex",flexDirection:t,alignItems:r,justifyContent:n,flexWrap:l,flexBasis:o,flexGrow:c,flexShrink:d},...u})});n.displayName="Flex"},79175:(e,s,t)=>{"use strict";t.d(s,{l:()=>d});var i=t(95155),r=t(78038),a=t(92622),n=t(26418),l=t(30044),o=t(17891),c=t(47415);let d=(0,l.R)(function(e,s){var t;let l=(0,o.V)("FormLabel",e),d=(0,r.M)(e),{className:h,children:m,requiredIndicator:p=(0,i.jsx)(u,{}),optionalIndicator:x=null,...g}=d,j=(0,n.Uc)(),f=null!==(t=null==j?void 0:j.getLabelProps(g,s))&&void 0!==t?t:{ref:s,...g};return(0,i.jsxs)(c.B.label,{...f,className:(0,a.cx)("chakra-form__label",d.className),__css:{display:"block",textAlign:"start",...l},children:[m,(null==j?void 0:j.isRequired)?p:x]})});d.displayName="FormLabel";let u=(0,l.R)(function(e,s){let t=(0,n.Uc)(),r=(0,n.TP)();if(!(null==t?void 0:t.isRequired))return null;let l=(0,a.cx)("chakra-form__required-indicator",e.className);return(0,i.jsx)(c.B.span,{...null==t?void 0:t.getRequiredIndicatorProps(e,s),__css:r.requiredIndicator,className:l})});u.displayName="RequiredIndicator"},80436:(e,s,t)=>{"use strict";t.d(s,{E:()=>c});var i=t(95155),r=t(78038),a=t(92622),n=t(30044),l=t(17891),o=t(47415);let c=(0,n.R)(function(e,s){let t=(0,l.V)("Badge",e),{className:n,...c}=(0,r.M)(e);return(0,i.jsx)(o.B.span,{ref:s,className:(0,a.cx)("chakra-badge",e.className),...c,__css:{display:"inline-block",whiteSpace:"nowrap",verticalAlign:"middle",...t}})});c.displayName="Badge"},84002:(e,s,t)=>{"use strict";t.d(s,{W:()=>i});let i=(0,t(24345).w)({d:"M23.384,21.619,16.855,15.09a9.284,9.284,0,1,0-1.768,1.768l6.529,6.529a1.266,1.266,0,0,0,1.768,0A1.251,1.251,0,0,0,23.384,21.619ZM2.75,9.5a6.75,6.75,0,1,1,6.75,6.75A6.758,6.758,0,0,1,2.75,9.5Z",displayName:"SearchIcon"})},88254:(e,s,t)=>{"use strict";t.d(s,{T:()=>h});var i=t(95155),r=t(78038),a=t(3304),n=t(92622),l=t(17248),o=t(30044),c=t(17891),d=t(47415);let u=["h","minH","height","minHeight"],h=(0,o.R)((e,s)=>{let t=(0,c.V)("Textarea",e),{className:o,rows:h,...m}=(0,r.M)(e),p=(0,l.t)(m),x=h?(0,a.c)(t,u):t;return(0,i.jsx)(d.B.textarea,{ref:s,rows:h,...p,className:(0,n.cx)("chakra-textarea",o),__css:x})});h.displayName="Textarea"},89342:(e,s,t)=>{"use strict";t.d(s,{O:()=>x});var i=t(95155),r=t(12115),a=t(35695),n=t(96918),l=t(7161);let o=()=>{let[e,s]=(0,r.useState)(null),[t,i]=(0,r.useState)(!0),o=(0,a.useRouter)();(0,r.useEffect)(()=>{let e=localStorage.getItem("user"),t=localStorage.getItem("token");if(t&&!document.cookie.includes("token=")&&(document.cookie="token=".concat(t,"; path=/; ").concat("secure;"," samesite=strict; max-age=86400")),e)try{let t=JSON.parse(e);t&&t.permissions&&(s(t),i(!1))}catch(e){console.error("解析本地用户数据失败:",e)}c()},[]);let c=async()=>{try{let e=(await n.A.get("/user/current")).data;if(e&&e.permissions){let t={...e,permissions:Array.isArray(e.permissions)?e.permissions:[]};s(t),localStorage.setItem("user",JSON.stringify(t))}else{let e=localStorage.getItem("user");if(e){let t=JSON.parse(e);s(t)}else o.push("/auth/login")}}catch(t){if(console.error("认证检查失败:",t),(0,l.HY)(t)){s(null),(0,l.Hl)();return}let e=localStorage.getItem("user");e?s(JSON.parse(e)):o.push("/auth/login")}finally{i(!1)}},d=(s,t)=>!!e&&!!e.permissions&&e.permissions.some(e=>t?e.resource===s&&e.action===t:e.resource===s);return{user:e,loading:t,hasPermission:d,hasManagerPermission:()=>d("MANAGER"),logout:()=>{localStorage.removeItem("user"),localStorage.removeItem("token"),localStorage.removeItem("refreshToken"),document.cookie="token=; path=/; expires=Thu, 01 Jan 1970 00:00:00 GMT",s(null),o.push("/auth/login")},checkAuth:c}};var c=t(77700),d=t(84492),u=t(79788),h=t(21688),m=t(75569),p=t(58670);let x=e=>{let{children:s,requiredPermission:t,requireManager:r=!1,fallbackPath:n="/main/dashboard"}=e,{user:l,loading:x,hasPermission:g,hasManagerPermission:j}=o(),f=(0,a.useRouter)();return x?(0,i.jsx)(c.a,{minH:"100vh",display:"flex",alignItems:"center",justifyContent:"center",children:(0,i.jsx)(d.y,{size:"lg",color:"blue.500"})}):l?r&&!j()?(0,i.jsx)(c.a,{p:8,children:(0,i.jsxs)(u.F,{status:"error",children:[(0,i.jsx)(h._,{}),(0,i.jsxs)(m.T,{align:"start",spacing:2,children:[(0,i.jsx)(p.E,{fontWeight:"bold",children:"访问被拒绝"}),(0,i.jsx)(p.E,{children:"您没有访问此页面的权限。需要管理员权限。"})]})]})}):t&&!g(t.resource,t.action)?(0,i.jsx)(c.a,{p:8,children:(0,i.jsxs)(u.F,{status:"error",children:[(0,i.jsx)(h._,{}),(0,i.jsxs)(m.T,{align:"start",spacing:2,children:[(0,i.jsx)(p.E,{fontWeight:"bold",children:"访问被拒绝"}),(0,i.jsxs)(p.E,{children:["您没有访问此页面的权限。需要权限: ",t.resource,t.action&&" - ".concat(t.action)]})]})]})}):(0,i.jsx)(i.Fragment,{children:s}):(f.push("/auth/login"),null)}},91985:(e,s,t)=>{"use strict";t.d(s,{R:()=>i});let i=(0,t(24345).w)({d:"M0,12a1.5,1.5,0,0,0,1.5,1.5h8.75a.25.25,0,0,1,.25.25V22.5a1.5,1.5,0,0,0,3,0V13.75a.25.25,0,0,1,.25-.25H22.5a1.5,1.5,0,0,0,0-3H13.75a.25.25,0,0,1-.25-.25V1.5a1.5,1.5,0,0,0-3,0v8.75a.25.25,0,0,1-.25.25H1.5A1.5,1.5,0,0,0,0,12Z",displayName:"AddIcon"})},96918:(e,s,t)=>{"use strict";t.d(s,{A:()=>l});var i=t(23464),r=t(7161),a=t(49509);let n=i.A.create({baseURL:a.env.NEXT_PUBLIC_API_URL||"http://localhost:8081/api/v1",timeout:36e5,headers:{"Content-Type":"application/json"}});n.interceptors.request.use(e=>{{let s=localStorage.getItem("token");s&&(e.headers.Authorization="Bearer ".concat(s))}return console.log("发送请求:",{url:e.url,method:e.method,baseURL:e.baseURL,headers:e.headers,fullPath:"".concat(e.baseURL).concat(e.url)}),e},e=>(console.error("请求拦截器错误:",e),Promise.reject(e))),n.interceptors.response.use(e=>{console.log("收到响应:",{url:e.config.url,status:e.status,data:e.data});let s=e.data;return s&&"object"==typeof s&&void 0!==s.code?0!==s.code&&200!==s.code?(console.error("API响应错误:",s),Promise.reject(Error(s.message||"请求失败"))):s:e},e=>{var s,t,i;return console.error("请求失败:",{url:null===(s=e.config)||void 0===s?void 0:s.url,message:e.message,response:null===(t=e.response)||void 0===t?void 0:t.data}),e.response?401===e.response.status?(0,r.Hl)():console.error("API错误:",(null===(i=e.response.data)||void 0===i?void 0:i.message)||"请求失败"):e.request?console.error("网络错误: 请检查网络连接"):console.error("请求错误:",e.message||"发生未知错误"),Promise.reject(e)});let l=n}},e=>{var s=s=>e(e.s=s);e.O(0,[8791,6829,6980,7039,2210,3464,3513,8277,5030,8441,1684,7358],()=>s(52104)),_N_E=e.O()}]);