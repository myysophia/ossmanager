(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[2],{7161:(e,s,t)=>{"use strict";t.d(s,{HY:()=>o,Hl:()=>r});let r=()=>{console.log("\uD83D\uDD10 认证令牌过期，清除认证信息并重定向到登录页..."),localStorage.removeItem("token"),localStorage.removeItem("user"),localStorage.removeItem("refreshToken"),document.cookie="token=; path=/; expires=Thu, 01 Jan 1970 00:00:00 GMT",window.location.pathname.includes("/auth/login")||(window.location.href="/auth/login")},o=e=>{var s;return e&&"object"==typeof e&&"response"in e&&(null===(s=e.response)||void 0===s?void 0:s.status)===401}},35490:(e,s,t)=>{"use strict";t.d(s,{d:()=>h});var r=t(95155),o=t(78038),a=t(92622),n=t(12115),i=t(1106),l=t(30044),c=t(17891),d=t(47415);let h=(0,l.R)(function(e,s){let t=(0,c.o)("Switch",e),{spacing:l="0.5rem",children:h,...u}=(0,o.M)(e),{getIndicatorProps:g,getInputProps:p,getCheckboxProps:x,getRootProps:j,getLabelProps:m}=(0,i.v)(u),f=(0,n.useMemo)(()=>({display:"inline-block",position:"relative",verticalAlign:"middle",lineHeight:0,...t.container}),[t.container]),y=(0,n.useMemo)(()=>({display:"inline-flex",flexShrink:0,justifyContent:"flex-start",boxSizing:"content-box",cursor:"pointer",...t.track}),[t.track]),_=(0,n.useMemo)(()=>({userSelect:"none",marginStart:l,...t.label}),[l,t.label]);return(0,r.jsxs)(d.B.label,{...j(),className:(0,a.cx)("chakra-switch",e.className),__css:f,children:[(0,r.jsx)("input",{className:"chakra-switch__input",...p({},s)}),(0,r.jsx)(d.B.span,{...x(),className:"chakra-switch__track",__css:y,children:(0,r.jsx)(d.B.span,{__css:t.thumb,className:"chakra-switch__thumb",...g()})}),h&&(0,r.jsx)(d.B.span,{className:"chakra-switch__label",...m(),__css:_,children:h})]})});h.displayName="Switch"},35695:(e,s,t)=>{"use strict";var r=t(18999);t.o(r,"usePathname")&&t.d(s,{usePathname:function(){return r.usePathname}}),t.o(r,"useRouter")&&t.d(s,{useRouter:function(){return r.useRouter}})},47622:(e,s,t)=>{Promise.resolve().then(t.bind(t,70329))},70329:(e,s,t)=>{"use strict";t.r(s),t.d(s,{default:()=>K});var r=t(95155),o=t(12115),a=t(23006),n=t(52017),i=t(7098),l=t(77700),c=t(6126),d=t(40988),h=t(96065),u=t(62833),g=t(93176),p=t(75569),x=t(58727),j=t(58670),m=t(77978),f=t(84492),y=t(37824),_=t(83382),v=t(47272),S=t(76122),C=t(66080),b=t(24710),k=t(80436),w=t(1996),A=t(831),E=t(39376),I=t(59771),T=t(82610),M=t(26418),N=t(79175),J=t(33636),R=t(35490),P=t(25442),O=t(64688),U=t(61549),L=t(27104),z=t(5643),q=t(4316),B=t(49174),W=t(10351),H=t(96918);class D{static async getAllStorageConfigs(){console.log("调用 getAllStorageConfigs");try{let e=await H.A.get("/oss/configs");console.log("API响应数据:",e.data);let s=e.data;if(!s||"object"!=typeof s)throw Error("API响应格式错误");if(!s.items||!Array.isArray(s.items))throw console.error("API响应结构:",{hasResponseData:!!s,responseData:s,hasItems:!!s.items,isArray:Array.isArray(s.items),itemsContent:s.items}),Error("API响应items字段格式错误");return console.log("解析后的存储配置列表:",s.items),s.items}catch(e){throw console.error("获取存储配置失败:",e),e}}static async getStorageConfig(e){console.log("调用 getStorageConfig, id:",e);try{var s;let t=await H.A.get("/oss/configs/".concat(e));if(!(null===(s=t.data)||void 0===s?void 0:s.data))throw Error("获取配置失败");return t.data.data}catch(e){throw console.error("获取单个配置失败:",e),e}}static async createStorageConfig(e){console.log("调用 createStorageConfig, config:",e);try{var s;let t=await H.A.post("/oss/configs",e);if(!(null===(s=t.data)||void 0===s?void 0:s.data))throw Error("创建配置失败");return t.data.data}catch(e){throw console.error("创建配置失败:",e),e}}static async updateStorageConfig(e,s){console.log("调用 updateStorageConfig, id:",e,"config:",s);try{var t;let r=await H.A.put("/oss/configs/".concat(e),s);if(!(null===(t=r.data)||void 0===t?void 0:t.data))throw Error("更新配置失败");return r.data.data}catch(e){throw console.error("更新配置失败:",e),e}}static async deleteStorageConfig(e){console.log("调用 deleteStorageConfig, id:",e);try{if(!(await H.A.delete("/oss/configs/".concat(e))).data)throw Error("删除配置失败");console.log("删除配置成功")}catch(e){throw console.error("删除配置失败:",e),e}}}class Y{static async getConfig(){console.log("获取系统配置");try{let e=await H.A.get("/system/config");return console.log("获取系统配置成功:",e.data),e.data.data}catch(e){throw console.error("获取系统配置失败:",e),e}}static async updateConfig(e){console.log("更新系统配置:",e);try{let s=await H.A.put("/system/config",e);return console.log("更新系统配置成功:",s.data),s.data.data}catch(e){throw console.error("更新系统配置失败:",e),e}}}var F=t(89342);function G(){let[e,s]=(0,o.useState)([]),[t,H]=(0,o.useState)({site_name:"",description:"",logo_url:"",max_file_size:5120,allowed_file_types:[],default_storage_config_id:0,enable_registration:!1,enable_captcha:!1}),[F,G]=(0,o.useState)(!1),[K,X]=(0,o.useState)(!1),[$,Z]=(0,o.useState)(null),[Q,V]=(0,o.useState)({name:"",storage_type:"ALIYUN_OSS",endpoint:"",access_key:"",secret_key:"",bucket:"",region:"",root_path:"",description:""}),ee=(0,a.d)(),{isOpen:es,onOpen:et,onClose:er}=(0,n.j)(),eo=(0,i.dU)("white","gray.800"),ea=(0,i.dU)("gray.200","gray.600");(0,o.useEffect)(()=>{console.log("组件加载，开始获取配置"),en(),ei()},[]);let en=async()=>{console.log("开始获取存储配置列表"),G(!0);try{let e=await D.getAllStorageConfigs();console.log("获取到存储配置:",e),s(e)}catch(e){console.error("获取存储配置失败:",e),ee({title:"获取存储配置失败",description:e instanceof Error?e.message:"未知错误",status:"error",duration:5e3,isClosable:!0})}finally{G(!1)}},ei=async()=>{console.log("开始获取系统配置"),X(!0);try{let e=await Y.getConfig();console.log("获取到系统配置:",e),H(e)}catch(e){console.error("获取系统配置失败:",e),ee({title:"获取系统配置失败",description:e instanceof Error?e.message:"未知错误",status:"error",duration:5e3,isClosable:!0})}finally{X(!1)}},el=async()=>{try{if(!(await fetch("/api/admin/storage-configs",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(Q)})).ok)throw Error("创建存储配置失败");en(),er(),V({name:"",storage_type:"ALIYUN_OSS",endpoint:"",access_key:"",secret_key:"",bucket:"",region:"",root_path:"",description:""}),ee({title:"创建存储配置成功",status:"success",duration:3e3,isClosable:!0})}catch(e){ee({title:"创建存储配置失败",description:e instanceof Error?e.message:"未知错误",status:"error",duration:5e3,isClosable:!0})}},ec=async()=>{if($)try{if(!(await fetch("/api/admin/storage-configs/".concat($.id),{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(Q)})).ok)throw Error("更新存储配置失败");en(),er(),Z(null),V({name:"",storage_type:"ALIYUN_OSS",endpoint:"",access_key:"",secret_key:"",bucket:"",region:"",root_path:"",description:""}),ee({title:"更新存储配置成功",status:"success",duration:3e3,isClosable:!0})}catch(e){ee({title:"更新存储配置失败",description:e instanceof Error?e.message:"未知错误",status:"error",duration:5e3,isClosable:!0})}},ed=async e=>{try{await D.deleteStorageConfig(Number(e)),ee({title:"删除存储配置成功",status:"success",duration:3e3,isClosable:!0}),en()}catch(e){console.error("删除配置失败:",e),ee({title:"删除存储配置失败",description:e instanceof Error?e.message:"未知错误",status:"error",duration:5e3,isClosable:!0})}},eh=async()=>{try{console.log("开始更新系统配置");let e=await Y.updateConfig(t);console.log("系统配置更新成功:",e),H(e),ee({title:"更新系统配置成功",status:"success",duration:3e3,isClosable:!0})}catch(e){console.error("更新系统配置失败:",e),ee({title:"更新系统配置失败",description:e instanceof Error?e.message:"未知错误",status:"error",duration:5e3,isClosable:!0})}},eu=e=>{Z(e),V({name:e.name,storage_type:e.storage_type,endpoint:e.endpoint||"",access_key:e.access_key,secret_key:e.secret_key,bucket:e.bucket,region:e.region||"",root_path:"",description:""}),et()};return(0,r.jsxs)(l.a,{p:6,children:[(0,r.jsxs)(c.t,{children:[(0,r.jsxs)(d.w,{children:[(0,r.jsx)(h.o,{children:"存储配置"}),(0,r.jsx)(h.o,{children:"系统设置"})]}),(0,r.jsxs)(u.T,{children:[(0,r.jsx)(g.K,{children:(0,r.jsxs)(p.T,{spacing:6,align:"stretch",children:[(0,r.jsxs)(x.z,{justify:"space-between",children:[(0,r.jsx)(j.E,{fontSize:"2xl",fontWeight:"bold",children:"存储配置"}),(0,r.jsx)(m.$,{leftIcon:(0,r.jsx)(W.GGD,{}),colorScheme:"blue",onClick:et,children:"添加配置"})]}),F?(0,r.jsxs)(l.a,{textAlign:"center",py:4,children:[(0,r.jsx)(f.y,{}),(0,r.jsx)(j.E,{mt:2,children:"加载中..."})]}):0===e.length?(0,r.jsx)(l.a,{textAlign:"center",py:4,children:(0,r.jsx)(j.E,{children:"暂无存储配置"})}):(0,r.jsx)(l.a,{overflowX:"auto",children:(0,r.jsxs)(y.X,{variant:"simple",bg:eo,borderWidth:"1px",borderColor:ea,children:[(0,r.jsx)(_.d,{children:(0,r.jsxs)(v.Tr,{children:[(0,r.jsx)(S.Th,{children:"名称"}),(0,r.jsx)(S.Th,{children:"类型"}),(0,r.jsx)(S.Th,{children:"状态"}),(0,r.jsx)(S.Th,{children:"描述"}),(0,r.jsx)(S.Th,{children:"操作"})]})}),(0,r.jsx)(C.N,{children:e.map(e=>(0,r.jsxs)(v.Tr,{children:[(0,r.jsx)(b.Td,{children:e.name}),(0,r.jsx)(b.Td,{children:e.storage_type}),(0,r.jsx)(b.Td,{children:(0,r.jsx)(k.E,{colorScheme:e.is_default?"green":"gray",children:e.is_default?"默认":"正常"})}),(0,r.jsx)(b.Td,{children:"-"}),(0,r.jsx)(b.Td,{children:(0,r.jsxs)(w.W,{children:[(0,r.jsx)(A.I,{as:E.K,icon:(0,r.jsx)(W.ZZB,{}),variant:"ghost",size:"sm"}),(0,r.jsxs)(I.c,{children:[(0,r.jsx)(T.D,{icon:(0,r.jsx)(W.WXf,{}),onClick:()=>eu(e),children:"编辑"}),(0,r.jsx)(T.D,{icon:(0,r.jsx)(W.IXo,{}),onClick:()=>ed(e.id),color:"red.500",children:"删除"})]})]})})]},e.id))})]})})]})}),(0,r.jsx)(g.K,{children:(0,r.jsxs)(p.T,{spacing:6,align:"stretch",children:[(0,r.jsx)(j.E,{fontSize:"2xl",fontWeight:"bold",children:"系统设置"}),K?(0,r.jsxs)(l.a,{textAlign:"center",py:4,children:[(0,r.jsx)(f.y,{}),(0,r.jsx)(j.E,{mt:2,children:"加载中..."})]}):(0,r.jsxs)(p.T,{spacing:4,align:"stretch",children:[(0,r.jsxs)(M.MJ,{children:[(0,r.jsx)(N.l,{children:"站点名称"}),(0,r.jsx)(J.p,{value:t.site_name,onChange:e=>H(s=>({...s,site_name:e.target.value}))})]}),(0,r.jsxs)(M.MJ,{children:[(0,r.jsx)(N.l,{children:"站点描述"}),(0,r.jsx)(J.p,{value:t.description,onChange:e=>H(s=>({...s,description:e.target.value}))})]}),(0,r.jsxs)(M.MJ,{children:[(0,r.jsx)(N.l,{children:"Logo URL"}),(0,r.jsx)(J.p,{value:t.logo_url,onChange:e=>H(s=>({...s,logo_url:e.target.value}))})]}),(0,r.jsxs)(M.MJ,{children:[(0,r.jsx)(N.l,{children:"最大文件大小 (MB)"}),(0,r.jsx)(J.p,{type:"number",value:t.max_file_size,onChange:e=>H(s=>({...s,max_file_size:Number(e.target.value)}))})]}),(0,r.jsxs)(M.MJ,{children:[(0,r.jsx)(N.l,{children:"允许的文件类型"}),(0,r.jsx)(J.p,{value:t.allowed_file_types.join(", "),onChange:e=>H(s=>({...s,allowed_file_types:e.target.value.split(",").map(e=>e.trim())})),placeholder:"用逗号分隔，例如：jpg, png, pdf"})]}),(0,r.jsxs)(M.MJ,{display:"flex",alignItems:"center",children:[(0,r.jsx)(N.l,{mb:"0",children:"启用注册"}),(0,r.jsx)(R.d,{isChecked:t.enable_registration,onChange:e=>H(s=>({...s,enable_registration:e.target.checked}))})]}),(0,r.jsxs)(M.MJ,{display:"flex",alignItems:"center",children:[(0,r.jsx)(N.l,{mb:"0",children:"启用验证码"}),(0,r.jsx)(R.d,{isChecked:t.enable_captcha,onChange:e=>H(s=>({...s,enable_captcha:e.target.checked}))})]}),(0,r.jsx)(m.$,{colorScheme:"blue",onClick:eh,children:"保存设置"})]})]})})]})]}),(0,r.jsxs)(P.aF,{isOpen:es,onClose:er,children:[(0,r.jsx)(O.m,{}),(0,r.jsxs)(U.$,{children:[(0,r.jsx)(L.r,{children:$?"编辑存储配置":"添加存储配置"}),(0,r.jsx)(z.c,{children:(0,r.jsxs)(p.T,{spacing:4,children:[(0,r.jsxs)(M.MJ,{isRequired:!0,children:[(0,r.jsx)(N.l,{children:"名称"}),(0,r.jsx)(J.p,{value:Q.name,onChange:e=>V(s=>({...s,name:e.target.value}))})]}),(0,r.jsxs)(M.MJ,{isRequired:!0,children:[(0,r.jsx)(N.l,{children:"存储类型"}),(0,r.jsxs)(q.l,{value:Q.storage_type,onChange:e=>V(s=>({...s,storage_type:e.target.value})),children:[(0,r.jsx)("option",{value:"ALIYUN_OSS",children:"阿里云 OSS"}),(0,r.jsx)("option",{value:"AWS_S3",children:"AWS S3"}),(0,r.jsx)("option",{value:"CLOUDFLARE_R2",children:"Cloudflare R2"})]})]}),(0,r.jsxs)(M.MJ,{isRequired:!0,children:[(0,r.jsx)(N.l,{children:"Endpoint"}),(0,r.jsx)(J.p,{value:Q.endpoint,onChange:e=>V(s=>({...s,endpoint:e.target.value}))})]}),(0,r.jsxs)(M.MJ,{isRequired:!0,children:[(0,r.jsx)(N.l,{children:"Access Key"}),(0,r.jsx)(J.p,{value:Q.access_key,onChange:e=>V(s=>({...s,access_key:e.target.value}))})]}),(0,r.jsxs)(M.MJ,{isRequired:!0,children:[(0,r.jsx)(N.l,{children:"Secret Key"}),(0,r.jsx)(J.p,{type:"password",value:Q.secret_key,onChange:e=>V(s=>({...s,secret_key:e.target.value}))})]}),(0,r.jsxs)(M.MJ,{isRequired:!0,children:[(0,r.jsx)(N.l,{children:"Bucket"}),(0,r.jsx)(J.p,{value:Q.bucket,onChange:e=>V(s=>({...s,bucket:e.target.value}))})]}),(0,r.jsxs)(M.MJ,{children:[(0,r.jsx)(N.l,{children:"Region"}),(0,r.jsx)(J.p,{value:Q.region||"",onChange:e=>V(s=>({...s,region:e.target.value}))})]}),(0,r.jsxs)(M.MJ,{children:[(0,r.jsx)(N.l,{children:"根路径"}),(0,r.jsx)(J.p,{value:Q.root_path||"",onChange:e=>V(s=>({...s,root_path:e.target.value}))})]}),(0,r.jsxs)(M.MJ,{children:[(0,r.jsx)(N.l,{children:"描述"}),(0,r.jsx)(J.p,{value:Q.description||"",onChange:e=>V(s=>({...s,description:e.target.value}))})]})]})}),(0,r.jsxs)(B.j,{children:[(0,r.jsx)(m.$,{variant:"ghost",mr:3,onClick:er,children:"取消"}),(0,r.jsx)(m.$,{colorScheme:"blue",onClick:$?ec:el,children:$?"更新":"创建"})]})]})]})]})}function K(){return(0,r.jsx)(F.O,{requireManager:!0,children:(0,r.jsx)(G,{})})}},89342:(e,s,t)=>{"use strict";t.d(s,{O:()=>x});var r=t(95155),o=t(12115),a=t(35695),n=t(96918),i=t(7161);let l=()=>{let[e,s]=(0,o.useState)(null),[t,r]=(0,o.useState)(!0),l=(0,a.useRouter)();(0,o.useEffect)(()=>{let e=localStorage.getItem("user"),t=localStorage.getItem("token");if(t&&!document.cookie.includes("token=")&&(document.cookie="token=".concat(t,"; path=/; ").concat("secure;"," samesite=strict; max-age=86400")),e)try{let t=JSON.parse(e);t&&t.permissions&&(s(t),r(!1))}catch(e){console.error("解析本地用户数据失败:",e)}c()},[]);let c=async()=>{try{let e=(await n.A.get("/user/current")).data;if(e&&e.permissions){let t={...e,permissions:Array.isArray(e.permissions)?e.permissions:[]};s(t),localStorage.setItem("user",JSON.stringify(t))}else{let e=localStorage.getItem("user");if(e){let t=JSON.parse(e);s(t)}else l.push("/auth/login")}}catch(t){if(console.error("认证检查失败:",t),(0,i.HY)(t)){s(null),(0,i.Hl)();return}let e=localStorage.getItem("user");e?s(JSON.parse(e)):l.push("/auth/login")}finally{r(!1)}},d=(s,t)=>!!e&&!!e.permissions&&e.permissions.some(e=>t?e.resource===s&&e.action===t:e.resource===s);return{user:e,loading:t,hasPermission:d,hasManagerPermission:()=>d("MANAGER"),logout:()=>{localStorage.removeItem("user"),localStorage.removeItem("token"),localStorage.removeItem("refreshToken"),document.cookie="token=; path=/; expires=Thu, 01 Jan 1970 00:00:00 GMT",s(null),l.push("/auth/login")},checkAuth:c}};var c=t(77700),d=t(84492),h=t(79788),u=t(21688),g=t(75569),p=t(58670);let x=e=>{let{children:s,requiredPermission:t,requireManager:o=!1,fallbackPath:n="/main/dashboard"}=e,{user:i,loading:x,hasPermission:j,hasManagerPermission:m}=l(),f=(0,a.useRouter)();return x?(0,r.jsx)(c.a,{minH:"100vh",display:"flex",alignItems:"center",justifyContent:"center",children:(0,r.jsx)(d.y,{size:"lg",color:"blue.500"})}):i?o&&!m()?(0,r.jsx)(c.a,{p:8,children:(0,r.jsxs)(h.F,{status:"error",children:[(0,r.jsx)(u._,{}),(0,r.jsxs)(g.T,{align:"start",spacing:2,children:[(0,r.jsx)(p.E,{fontWeight:"bold",children:"访问被拒绝"}),(0,r.jsx)(p.E,{children:"您没有访问此页面的权限。需要管理员权限。"})]})]})}):t&&!j(t.resource,t.action)?(0,r.jsx)(c.a,{p:8,children:(0,r.jsxs)(h.F,{status:"error",children:[(0,r.jsx)(u._,{}),(0,r.jsxs)(g.T,{align:"start",spacing:2,children:[(0,r.jsx)(p.E,{fontWeight:"bold",children:"访问被拒绝"}),(0,r.jsxs)(p.E,{children:["您没有访问此页面的权限。需要权限: ",t.resource,t.action&&" - ".concat(t.action)]})]})]})}):(0,r.jsx)(r.Fragment,{children:s}):(f.push("/auth/login"),null)}},96918:(e,s,t)=>{"use strict";t.d(s,{A:()=>i});var r=t(23464),o=t(7161),a=t(49509);let n=r.A.create({baseURL:a.env.NEXT_PUBLIC_API_URL||"http://localhost:8081/api/v1",timeout:36e5,headers:{"Content-Type":"application/json"}});n.interceptors.request.use(e=>{{let s=localStorage.getItem("token");s&&(e.headers.Authorization="Bearer ".concat(s))}return console.log("发送请求:",{url:e.url,method:e.method,baseURL:e.baseURL,headers:e.headers,fullPath:"".concat(e.baseURL).concat(e.url)}),e},e=>(console.error("请求拦截器错误:",e),Promise.reject(e))),n.interceptors.response.use(e=>{console.log("收到响应:",{url:e.config.url,status:e.status,data:e.data});let s=e.data;return s&&"object"==typeof s&&void 0!==s.code?0!==s.code&&200!==s.code?(console.error("API响应错误:",s),Promise.reject(Error(s.message||"请求失败"))):s:e},e=>{var s,t,r;return console.error("请求失败:",{url:null===(s=e.config)||void 0===s?void 0:s.url,message:e.message,response:null===(t=e.response)||void 0===t?void 0:t.data}),e.response?401===e.response.status?(0,o.Hl)():console.error("API错误:",(null===(r=e.response.data)||void 0===r?void 0:r.message)||"请求失败"):e.request?console.error("网络错误: 请检查网络连接"):console.error("请求错误:",e.message||"发生未知错误"),Promise.reject(e)});let i=n}},e=>{var s=s=>e(e.s=s);e.O(0,[844,8791,6829,6980,7039,2210,3464,3513,8277,6654,8815,4415,8441,1684,7358],()=>s(47622)),_N_E=e.O()}]);