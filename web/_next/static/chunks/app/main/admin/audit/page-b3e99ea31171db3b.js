(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[9250],{7161:(e,t,r)=>{"use strict";r.d(t,{HY:()=>o,Hl:()=>s});let s=()=>{console.log("\uD83D\uDD10 认证令牌过期，清除认证信息并重定向到登录页..."),localStorage.removeItem("token"),localStorage.removeItem("user"),localStorage.removeItem("refreshToken"),document.cookie="token=; path=/; expires=Thu, 01 Jan 1970 00:00:00 GMT",window.location.pathname.includes("/auth/login")||(window.location.href="/auth/login")},o=e=>{var t;return e&&"object"==typeof e&&"response"in e&&(null===(t=e.response)||void 0===t?void 0:t.status)===401}},20468:(e,t,r)=>{"use strict";r.r(t),r.d(t,{default:()=>_});var s=r(95155),o=r(12115),l=r(23006),n=r(80436),a=r(22900),i=r(77700),c=r(11649),d=r(58670),u=r(59108),h=r(58727),m=r(33636),x=r(77978),p=r(37824),j=r(83382),g=r(47272),f=r(76122),v=r(66080),T=r(24710),S=r(4316),b=r(10351),k=r(96918),y=r(89342);function I(e){if(!e)return;let t=new Date(e),r=e=>e.toString().padStart(2,"0"),s=t.getFullYear(),o=r(t.getMonth()+1),l=r(t.getDate()),n=r(t.getHours()),a=r(t.getMinutes()),i=r(t.getSeconds()),c=-t.getTimezoneOffset(),d=Math.abs(c),u=r(Math.floor(d/60)),h=r(d%60);return"".concat(s,"-").concat(o,"-").concat(l,"T").concat(n,":").concat(a,":").concat(i).concat(c>=0?"+":"-").concat(u,":").concat(h)}function E(){let[e,t]=(0,o.useState)([]),[r,y]=(0,o.useState)(!0),[E,_]=(0,o.useState)({from:"",to:""}),[w,C]=(0,o.useState)(1),[A,N]=(0,o.useState)(10),[P,M]=(0,o.useState)(0),O=(0,l.d)(),R=async()=>{y(!0);try{let e={page:w,page_size:A};E.from&&(e.start_time=I(E.from)),E.to&&(e.end_time=I(E.to));let r=(await k.A.get("/audit/logs",{params:e})).data;r&&r.items?(t(r.items),M(r.total||0)):(t([]),M(0),O({title:"获取日志失败",status:"error",duration:2e3,isClosable:!0}))}catch(e){t([]),M(0),O({title:"获取日志失败",status:"error",duration:2e3,isClosable:!0})}finally{y(!1)}};(0,o.useEffect)(()=>{R()},[w,A,E.from,E.to]);let H=e=>{let t="200"===e||"success"===e;return(0,s.jsx)(n.E,{colorScheme:t?"green":"red",px:2,py:1,borderRadius:"full",children:t?"成功":"失败"})};return(0,s.jsx)(a.m,{maxW:"container.xl",py:10,children:(0,s.jsxs)(i.a,{mb:6,children:[(0,s.jsx)(c.D,{size:"lg",mb:4,children:"审计日志"}),(0,s.jsx)(d.E,{color:"gray.500",mb:6,children:"查看和搜索系统操作记录"}),(0,s.jsx)(u.s,{direction:{base:"column",md:"row"},gap:4,mb:6,children:(0,s.jsxs)(h.z,{flex:1,children:[(0,s.jsx)(d.E,{minW:"80px",children:"时间范围:"}),(0,s.jsx)(m.p,{type:"datetime-local",placeholder:"开始时间",value:E.from,onChange:e=>_({...E,from:e.target.value})}),(0,s.jsx)(d.E,{children:"至"}),(0,s.jsx)(m.p,{type:"datetime-local",placeholder:"结束时间",value:E.to,onChange:e=>_({...E,to:e.target.value})}),(0,s.jsx)(x.$,{leftIcon:(0,s.jsx)(b.wIk,{}),onClick:()=>{C(1),R(),O({title:"搜索完成",status:"success",duration:2e3,isClosable:!0})},children:"搜索"})]})}),r?(0,s.jsx)(d.E,{children:"加载中..."}):(0,s.jsxs)(i.a,{overflowX:"auto",children:[(0,s.jsxs)(p.X,{variant:"simple",children:[(0,s.jsx)(j.d,{children:(0,s.jsxs)(g.Tr,{children:[(0,s.jsx)(f.Th,{children:"时间"}),(0,s.jsx)(f.Th,{children:"用户"}),(0,s.jsx)(f.Th,{children:"操作"}),(0,s.jsx)(f.Th,{children:"资源类型"}),(0,s.jsx)(f.Th,{children:"资源ID"}),(0,s.jsx)(f.Th,{children:"IP地址"}),(0,s.jsx)(f.Th,{children:"状态"}),(0,s.jsx)(f.Th,{children:"详情"})]})}),(0,s.jsx)(v.N,{children:e.map(e=>(0,s.jsxs)(g.Tr,{children:[(0,s.jsx)(T.Td,{children:e.created_at}),(0,s.jsx)(T.Td,{children:e.username}),(0,s.jsx)(T.Td,{children:e.action}),(0,s.jsx)(T.Td,{children:e.resource_type}),(0,s.jsx)(T.Td,{children:e.resource_id}),(0,s.jsx)(T.Td,{children:e.ip_address}),(0,s.jsx)(T.Td,{children:H(e.status)}),(0,s.jsx)(T.Td,{children:(0,s.jsx)(d.E,{maxW:"300px",whiteSpace:"pre-wrap",wordBreak:"break-all",children:e.details})})]},e.id))})]}),(0,s.jsxs)(u.s,{justify:"space-between",align:"center",mt:4,children:[(0,s.jsx)(x.$,{onClick:()=>C(w-1),isDisabled:1===w,children:"上一页"}),(0,s.jsxs)(d.E,{children:["第 ",w," 页 / 共 ",Math.ceil(P/A)||1," 页（共 ",P," 条）"]}),(0,s.jsx)(x.$,{onClick:()=>C(w+1),isDisabled:w*A>=P,children:"下一页"}),(0,s.jsxs)(S.l,{value:A,onChange:e=>{N(Number(e.target.value)),C(1)},width:"100px",ml:4,children:[(0,s.jsx)("option",{value:10,children:"10条/页"}),(0,s.jsx)("option",{value:20,children:"20条/页"}),(0,s.jsx)("option",{value:50,children:"50条/页"}),(0,s.jsx)("option",{value:100,children:"100条/页"})]})]})]})]})})}function _(){return(0,s.jsx)(y.O,{requireManager:!0,children:(0,s.jsx)(E,{})})}},89342:(e,t,r)=>{"use strict";r.d(t,{O:()=>p});var s=r(95155),o=r(12115),l=r(35695),n=r(96918),a=r(7161);let i=()=>{let[e,t]=(0,o.useState)(null),[r,s]=(0,o.useState)(!0),i=(0,l.useRouter)();(0,o.useEffect)(()=>{let e=localStorage.getItem("user"),r=localStorage.getItem("token");if(r&&!document.cookie.includes("token=")&&(document.cookie="token=".concat(r,"; path=/; ").concat("secure;"," samesite=strict; max-age=86400")),e)try{let r=JSON.parse(e);r&&r.permissions&&(t(r),s(!1))}catch(e){console.error("解析本地用户数据失败:",e)}c()},[]);let c=async()=>{try{let e=(await n.A.get("/user/current")).data;if(e&&e.permissions){let r={...e,permissions:Array.isArray(e.permissions)?e.permissions:[]};t(r),localStorage.setItem("user",JSON.stringify(r))}else{let e=localStorage.getItem("user");if(e){let r=JSON.parse(e);t(r)}else i.push("/auth/login")}}catch(r){if(console.error("认证检查失败:",r),(0,a.HY)(r)){t(null),(0,a.Hl)();return}let e=localStorage.getItem("user");e?t(JSON.parse(e)):i.push("/auth/login")}finally{s(!1)}},d=(t,r)=>!!e&&!!e.permissions&&e.permissions.some(e=>r?e.resource===t&&e.action===r:e.resource===t);return{user:e,loading:r,hasPermission:d,hasManagerPermission:()=>d("MANAGER"),logout:()=>{localStorage.removeItem("user"),localStorage.removeItem("token"),localStorage.removeItem("refreshToken"),document.cookie="token=; path=/; expires=Thu, 01 Jan 1970 00:00:00 GMT",t(null),i.push("/auth/login")},checkAuth:c}};var c=r(77700),d=r(84492),u=r(79788),h=r(21688),m=r(75569),x=r(58670);let p=e=>{let{children:t,requiredPermission:r,requireManager:o=!1,fallbackPath:n="/main/dashboard"}=e,{user:a,loading:p,hasPermission:j,hasManagerPermission:g}=i(),f=(0,l.useRouter)();return p?(0,s.jsx)(c.a,{minH:"100vh",display:"flex",alignItems:"center",justifyContent:"center",children:(0,s.jsx)(d.y,{size:"lg",color:"blue.500"})}):a?o&&!g()?(0,s.jsx)(c.a,{p:8,children:(0,s.jsxs)(u.F,{status:"error",children:[(0,s.jsx)(h._,{}),(0,s.jsxs)(m.T,{align:"start",spacing:2,children:[(0,s.jsx)(x.E,{fontWeight:"bold",children:"访问被拒绝"}),(0,s.jsx)(x.E,{children:"您没有访问此页面的权限。需要管理员权限。"})]})]})}):r&&!j(r.resource,r.action)?(0,s.jsx)(c.a,{p:8,children:(0,s.jsxs)(u.F,{status:"error",children:[(0,s.jsx)(h._,{}),(0,s.jsxs)(m.T,{align:"start",spacing:2,children:[(0,s.jsx)(x.E,{fontWeight:"bold",children:"访问被拒绝"}),(0,s.jsxs)(x.E,{children:["您没有访问此页面的权限。需要权限: ",r.resource,r.action&&" - ".concat(r.action)]})]})]})}):(0,s.jsx)(s.Fragment,{children:t}):(f.push("/auth/login"),null)}},96918:(e,t,r)=>{"use strict";r.d(t,{A:()=>a});var s=r(23464),o=r(7161),l=r(87358);let n=s.A.create({baseURL:l.env.NEXT_PUBLIC_API_URL||"http://localhost:8081/api/v1",timeout:36e5,headers:{"Content-Type":"application/json"}});n.interceptors.request.use(e=>{{let t=localStorage.getItem("token");t&&(e.headers.Authorization="Bearer ".concat(t))}return console.log("发送请求:",{url:e.url,method:e.method,baseURL:e.baseURL,headers:e.headers,fullPath:"".concat(e.baseURL).concat(e.url)}),e},e=>(console.error("请求拦截器错误:",e),Promise.reject(e))),n.interceptors.response.use(e=>{console.log("收到响应:",{url:e.config.url,status:e.status,data:e.data});let t=e.data;return t&&"object"==typeof t&&void 0!==t.code?0!==t.code&&200!==t.code?(console.error("API响应错误:",t),Promise.reject(Error(t.message||"请求失败"))):t:e},e=>{var t,r,s;return console.error("请求失败:",{url:null===(t=e.config)||void 0===t?void 0:t.url,message:e.message,response:null===(r=e.response)||void 0===r?void 0:r.data}),e.response?401===e.response.status?(0,o.Hl)():console.error("API错误:",(null===(s=e.response.data)||void 0===s?void 0:s.message)||"请求失败"):e.request?console.error("网络错误: 请检查网络连接"):console.error("请求错误:",e.message||"发生未知错误"),Promise.reject(e)});let a=n},99290:(e,t,r)=>{Promise.resolve().then(r.bind(r,20468))}},e=>{var t=t=>e(e.s=t);e.O(0,[844,8791,6829,6980,7039,2210,3464,8863,8441,1684,7358],()=>t(99290)),_N_E=e.O()}]);