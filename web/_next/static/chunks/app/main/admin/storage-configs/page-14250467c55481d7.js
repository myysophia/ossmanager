(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[8250],{34412:(e,s,r)=>{"use strict";r.r(s),r.d(s,{default:()=>q});var t=r(95155),l=r(12115),i=r(52017),n=r(23006),a=r(22900),c=r(77700),o=r(58727),d=r(11649),u=r(77978),h=r(37824),x=r(83382),j=r(47272),p=r(76122),g=r(66080),m=r(24710),y=r(58670),f=r(80436),b=r(39376),S=r(25442),_=r(64688),k=r(61549),C=r(27104),v=r(19782),T=r(5643),E=r(75569),R=r(26418),w=r(79175),J=r(33636),A=r(4316),M=r(88254),O=r(10351),I=r(14509),z=r(89342);function N(){let[e,s]=(0,l.useState)([]),[r,S]=(0,l.useState)(!0),[_,k]=(0,l.useState)(null),{isOpen:C,onOpen:v,onClose:T}=(0,i.j)(),E=(0,n.d)(),R=async()=>{try{let e=await I.bH.getConfigs();s(e.items||[])}catch(e){console.error("获取存储配置失败:",e),E({title:"获取存储配置失败",status:"error",duration:3e3,isClosable:!0})}finally{S(!1)}};(0,l.useEffect)(()=>{R()},[]);let w=async e=>{if(window.confirm("确定要删除此配置吗？"))try{await I.bH.deleteConfig(e),E({title:"删除成功",status:"success",duration:3e3,isClosable:!0}),R()}catch(e){console.error("删除配置失败:",e),E({title:"删除配置失败",status:"error",duration:3e3,isClosable:!0})}},J=async e=>{try{await I.bH.setDefaultConfig(e),E({title:"设置默认配置成功",status:"success",duration:3e3,isClosable:!0}),R()}catch(e){console.error("设置默认配置失败:",e),E({title:"设置默认配置失败",status:"error",duration:3e3,isClosable:!0})}},A=async e=>{try{let s=await I.bH.testConnection(e);E({title:s?"连接测试成功":"连接测试失败",status:s?"success":"error",duration:3e3,isClosable:!0})}catch(e){console.error("测试连接失败:",e),E({title:"测试连接失败",status:"error",duration:3e3,isClosable:!0})}};return(0,t.jsxs)(a.m,{maxW:"container.xl",py:8,children:[(0,t.jsx)(c.a,{mb:6,children:(0,t.jsxs)(o.z,{justify:"space-between",children:[(0,t.jsx)(d.D,{size:"lg",children:"存储配置管理"}),(0,t.jsx)(u.$,{leftIcon:(0,t.jsx)(O.GGD,{}),colorScheme:"blue",onClick:()=>{k(null),v()},children:"添加配置"})]})}),(0,t.jsxs)(h.X,{variant:"simple",children:[(0,t.jsx)(x.d,{children:(0,t.jsxs)(j.Tr,{children:[(0,t.jsx)(p.Th,{children:"名称"}),(0,t.jsx)(p.Th,{children:"存储类型"}),(0,t.jsx)(p.Th,{children:"Bucket"}),(0,t.jsx)(p.Th,{children:"Region"}),(0,t.jsx)(p.Th,{children:"状态"}),(0,t.jsx)(p.Th,{children:"操作"})]})}),(0,t.jsx)(g.N,{children:e.map(e=>(0,t.jsxs)(j.Tr,{children:[(0,t.jsx)(m.Td,{children:(0,t.jsxs)(o.z,{children:[(0,t.jsx)(y.E,{children:e.name}),e.is_default&&(0,t.jsx)(f.E,{colorScheme:"green",children:"默认"})]})}),(0,t.jsx)(m.Td,{children:e.storage_type}),(0,t.jsx)(m.Td,{children:e.bucket}),(0,t.jsx)(m.Td,{children:e.region}),(0,t.jsx)(m.Td,{children:(0,t.jsx)(f.E,{colorScheme:"blue",children:e.is_default?"默认":"正常"})}),(0,t.jsx)(m.Td,{children:(0,t.jsxs)(o.z,{spacing:2,children:[(0,t.jsx)(b.K,{"aria-label":"编辑",icon:(0,t.jsx)(O.WXf,{}),size:"sm",onClick:()=>{k(e),v()}}),(0,t.jsx)(b.K,{"aria-label":"删除",icon:(0,t.jsx)(O.IXo,{}),size:"sm",colorScheme:"red",onClick:()=>w(e.id)}),(0,t.jsx)(b.K,{"aria-label":"设为默认",icon:(0,t.jsx)(O.usP,{}),size:"sm",colorScheme:e.is_default?"yellow":"gray",onClick:()=>J(e.id)}),(0,t.jsx)(u.$,{size:"sm",onClick:()=>A(e.id),children:"测试连接"})]})})]},e.id))})]}),(0,t.jsx)(H,{isOpen:C,onClose:T,config:_,onSuccess:()=>{T(),R()}})]})}function H(e){let{isOpen:s,onClose:r,config:i,onSuccess:a}=e,[c,o]=(0,l.useState)({name:"",storage_type:"AWS_S3",access_key:"",secret_key:"",region:"",bucket:"",endpoint:"",root_path:"",description:""}),d=(0,n.d)();(0,l.useEffect)(()=>{i?o({name:i.name,storage_type:i.storage_type,access_key:i.access_key,secret_key:"",region:i.region,bucket:i.bucket,endpoint:i.endpoint,root_path:i.root_path||"",description:i.description||""}):o({name:"",storage_type:"AWS_S3",access_key:"",secret_key:"",region:"",bucket:"",endpoint:"",root_path:"",description:""})},[i]);let h=async e=>{e.preventDefault();try{i?(await I.bH.updateConfig(i.id,c),d({title:"更新配置成功",status:"success",duration:3e3,isClosable:!0})):(await I.bH.createConfig(c),d({title:"创建配置成功",status:"success",duration:3e3,isClosable:!0})),a()}catch(e){console.error("保存配置失败:",e),d({title:"保存配置失败",status:"error",duration:3e3,isClosable:!0})}};return(0,t.jsxs)(S.aF,{isOpen:s,onClose:r,size:"xl",children:[(0,t.jsx)(_.m,{}),(0,t.jsxs)(k.$,{children:[(0,t.jsx)(C.r,{children:i?"编辑存储配置":"创建存储配置"}),(0,t.jsx)(v.s,{}),(0,t.jsx)(T.c,{children:(0,t.jsx)("form",{onSubmit:h,children:(0,t.jsxs)(E.T,{spacing:4,children:[(0,t.jsxs)(R.MJ,{isRequired:!0,children:[(0,t.jsx)(w.l,{children:"配置名称"}),(0,t.jsx)(J.p,{value:c.name,onChange:e=>o({...c,name:e.target.value}),placeholder:"请输入配置名称"})]}),(0,t.jsxs)(R.MJ,{isRequired:!0,children:[(0,t.jsx)(w.l,{children:"存储类型"}),(0,t.jsxs)(A.l,{value:c.storage_type,onChange:e=>o({...c,storage_type:e.target.value}),children:[(0,t.jsx)("option",{value:"ALIYUN_OSS",children:"阿里云OSS"}),(0,t.jsx)("option",{value:"AWS_S3",children:"AWS S3"}),(0,t.jsx)("option",{value:"CLOUDFLARE_R2",children:"Cloudflare R2"})]})]}),(0,t.jsxs)(R.MJ,{isRequired:!0,children:[(0,t.jsx)(w.l,{children:"Access Key"}),(0,t.jsx)(J.p,{value:c.access_key,onChange:e=>o({...c,access_key:e.target.value}),placeholder:"请输入Access Key"})]}),(0,t.jsxs)(R.MJ,{isRequired:!0,children:[(0,t.jsx)(w.l,{children:"Secret Key"}),(0,t.jsx)(J.p,{type:"password",value:c.secret_key,onChange:e=>o({...c,secret_key:e.target.value}),placeholder:i?"不修改请留空":"请输入Secret Key"})]}),(0,t.jsxs)(R.MJ,{isRequired:!0,children:[(0,t.jsx)(w.l,{children:"Region"}),(0,t.jsx)(J.p,{value:c.region,onChange:e=>o({...c,region:e.target.value}),placeholder:"请输入Region"})]}),(0,t.jsxs)(R.MJ,{isRequired:!0,children:[(0,t.jsx)(w.l,{children:"Bucket"}),(0,t.jsx)(J.p,{value:c.bucket,onChange:e=>o({...c,bucket:e.target.value}),placeholder:"请输入Bucket名称"})]}),(0,t.jsxs)(R.MJ,{isRequired:!0,children:[(0,t.jsx)(w.l,{children:"Endpoint"}),(0,t.jsx)(J.p,{value:c.endpoint,onChange:e=>o({...c,endpoint:e.target.value}),placeholder:"请输入Endpoint地址"})]}),(0,t.jsxs)(R.MJ,{children:[(0,t.jsx)(w.l,{children:"根路径"}),(0,t.jsx)(J.p,{value:c.root_path,onChange:e=>o({...c,root_path:e.target.value}),placeholder:"请输入根路径（可选）"})]}),(0,t.jsxs)(R.MJ,{children:[(0,t.jsx)(w.l,{children:"描述"}),(0,t.jsx)(M.T,{value:c.description,onChange:e=>o({...c,description:e.target.value}),placeholder:"请输入配置描述（可选）"})]}),(0,t.jsx)(u.$,{type:"submit",colorScheme:"blue",width:"full",children:i?"更新":"创建"})]})})})]})]})}function q(){return(0,t.jsx)(z.O,{requireManager:!0,children:(0,t.jsx)(N,{})})}},89342:(e,s,r)=>{"use strict";r.d(s,{O:()=>p});var t=r(95155),l=r(12115),i=r(35695),n=r(96918),a=r(7161);let c=()=>{let[e,s]=(0,l.useState)(null),[r,t]=(0,l.useState)(!0),c=(0,i.useRouter)();(0,l.useEffect)(()=>{let e=localStorage.getItem("user"),r=localStorage.getItem("token");if(r&&!document.cookie.includes("token=")&&(document.cookie="token=".concat(r,"; path=/; ").concat("secure;"," samesite=strict; max-age=86400")),e)try{let r=JSON.parse(e);r&&r.permissions&&(s(r),t(!1))}catch(e){console.error("解析本地用户数据失败:",e)}o()},[]);let o=async()=>{try{let e=(await n.A.get("/user/current")).data;if(e&&e.permissions){let r={...e,permissions:Array.isArray(e.permissions)?e.permissions:[]};s(r),localStorage.setItem("user",JSON.stringify(r))}else{let e=localStorage.getItem("user");if(e){let r=JSON.parse(e);s(r)}else c.push("/auth/login")}}catch(r){if(console.error("认证检查失败:",r),(0,a.HY)(r)){s(null),(0,a.Hl)();return}let e=localStorage.getItem("user");e?s(JSON.parse(e)):c.push("/auth/login")}finally{t(!1)}},d=(s,r)=>!!e&&!!e.permissions&&e.permissions.some(e=>r?e.resource===s&&e.action===r:e.resource===s);return{user:e,loading:r,hasPermission:d,hasManagerPermission:()=>d("MANAGER"),logout:()=>{localStorage.removeItem("user"),localStorage.removeItem("token"),localStorage.removeItem("refreshToken"),document.cookie="token=; path=/; expires=Thu, 01 Jan 1970 00:00:00 GMT",s(null),c.push("/auth/login")},checkAuth:o}};var o=r(77700),d=r(84492),u=r(79788),h=r(21688),x=r(75569),j=r(58670);let p=e=>{let{children:s,requiredPermission:r,requireManager:l=!1,fallbackPath:n="/main/dashboard"}=e,{user:a,loading:p,hasPermission:g,hasManagerPermission:m}=c(),y=(0,i.useRouter)();return p?(0,t.jsx)(o.a,{minH:"100vh",display:"flex",alignItems:"center",justifyContent:"center",children:(0,t.jsx)(d.y,{size:"lg",color:"blue.500"})}):a?l&&!m()?(0,t.jsx)(o.a,{p:8,children:(0,t.jsxs)(u.F,{status:"error",children:[(0,t.jsx)(h._,{}),(0,t.jsxs)(x.T,{align:"start",spacing:2,children:[(0,t.jsx)(j.E,{fontWeight:"bold",children:"访问被拒绝"}),(0,t.jsx)(j.E,{children:"您没有访问此页面的权限。需要管理员权限。"})]})]})}):r&&!g(r.resource,r.action)?(0,t.jsx)(o.a,{p:8,children:(0,t.jsxs)(u.F,{status:"error",children:[(0,t.jsx)(h._,{}),(0,t.jsxs)(x.T,{align:"start",spacing:2,children:[(0,t.jsx)(j.E,{fontWeight:"bold",children:"访问被拒绝"}),(0,t.jsxs)(j.E,{children:["您没有访问此页面的权限。需要权限: ",r.resource,r.action&&" - ".concat(r.action)]})]})]})}):(0,t.jsx)(t.Fragment,{children:s}):(y.push("/auth/login"),null)}},99890:(e,s,r)=>{Promise.resolve().then(r.bind(r,34412))}},e=>{var s=s=>e(e.s=s);e.O(0,[844,8791,6829,6980,7039,2210,3464,3513,1434,4509,8441,1684,7358],()=>s(99890)),_N_E=e.O()}]);