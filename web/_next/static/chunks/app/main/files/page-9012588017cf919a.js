(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[8502],{9387:(e,n,s)=>{"use strict";s.r(n),s.d(n,{default:()=>ea});var i=s(15933),t=s(95155),l=s(12115),a=s(23006),o=s(52017),r=s(22900),c=s(77700),d=s(59108),h=s(11649),u=s(77978),x=s(58727),m=s(33636),j=s(84492),g=s(75569),p=s(58670),b=s(37824),f=s(83382),w=s(47272),z=s(76122),y=s(26584),v=s(66080),C=s(24710),k=s(39376),E=s(4316),S=s(25442),_=s(64688),T=s(61549),D=s(27104),N=s(19782),F=s(5643),L=s(49174),R=s(10351),M=s(72515),$=s(13380),I=s(96918),U=s(45270),W=s(47315),O=s(60078),B=s(74633),A=s(79788),K=s(21688),P=s(42066),X=s(49747),G=s(49004),H=s(60525),q=s(43508),Z=s(58388),J=s(74093),Q=s(17862),V=s(14509),Y=s(16862);let ee=[{value:"1",label:"1小时"},{value:"2",label:"2小时"},{value:"3",label:"3小时"},{value:"6",label:"6小时"},{value:"12",label:"12小时"},{value:"24",label:"24小时"},{value:"48",label:"48小时"},{value:"0",label:"永不过期"}],en=e=>{let{isOpen:n,onClose:s,file:i}=e,[o,r]=(0,l.useState)("24"),[h,j]=(0,l.useState)(""),[b,f]=(0,l.useState)(!1),[w,z]=(0,l.useState)(!1),[y,v]=(0,l.useState)(null),[C,E]=(0,l.useState)(!1),[R,M]=(0,l.useState)(""),{hasCopied:$,onCopy:I}=(0,U.i)(h),en=(0,a.d)(),es=()=>{r("24"),j(""),z(!1),v(null),E(!1),M("")};(0,l.useEffect)(()=>{n||es()},[n]);let ei=async()=>{if(i){f(!0);try{let e=parseInt(o),n=await V.zh.getFileDownloadURL(i.id,e);if(n.download_url){j(n.download_url),E(n.never_expires||!1),v(n.expires||null);try{let e=await Y.toDataURL(n.download_url,{width:200,margin:2,color:{dark:"#000000",light:"#FFFFFF"}});M(e)}catch(e){console.error("生成二维码失败:",e)}z(!0),en({title:"分享链接生成成功",status:"success",duration:3e3,isClosable:!0})}}catch(e){console.error("生成分享链接失败:",e),en({title:"生成分享链接失败",description:e instanceof Error?e.message:"请重试",status:"error",duration:5e3,isClosable:!0})}finally{f(!1)}}},et=()=>{I(),en({title:"链接已复制",description:"分享链接已复制到剪贴板",status:"success",duration:2e3,isClosable:!0})};return(0,t.jsxs)(S.aF,{isOpen:n,onClose:s,size:"xl",children:[(0,t.jsx)(_.m,{}),(0,t.jsxs)(T.$,{children:[(0,t.jsx)(D.r,{children:"分享文件链接"}),(0,t.jsx)(N.s,{}),(0,t.jsx)(F.c,{children:(0,t.jsxs)(g.T,{spacing:4,align:"stretch",children:[i&&(0,t.jsxs)(c.a,{p:4,bg:"gray.50",borderRadius:"md",children:[(0,t.jsx)(p.E,{fontSize:"sm",color:"gray.600",children:"分享文件"}),(0,t.jsx)(p.E,{fontWeight:"medium",isTruncated:!0,title:i.original_filename,children:i.original_filename}),(0,t.jsxs)(p.E,{fontSize:"sm",color:"gray.500",children:["大小: ",(i.file_size/1024/1024).toFixed(2)," MB"]})]}),w?(0,t.jsxs)(t.Fragment,{children:[(0,t.jsxs)(c.a,{children:[(0,t.jsx)(p.E,{mb:2,fontWeight:"medium",children:"分享链接"}),(0,t.jsxs)(P.M,{children:[(0,t.jsx)(m.p,{value:h,isReadOnly:!0,fontSize:"sm",bg:"gray.50",_focus:{bg:"gray.50"}}),(0,t.jsx)(X.t,{children:(0,t.jsx)(k.K,{"aria-label":"复制链接",icon:$?(0,t.jsx)(Z.S,{}):(0,t.jsx)(J.T,{}),size:"sm",colorScheme:$?"green":"blue",variant:"ghost",onClick:et})})]})]}),R&&(0,t.jsxs)(c.a,{children:[(0,t.jsx)(p.E,{mb:3,fontWeight:"medium",children:"扫码下载"}),(0,t.jsxs)(d.s,{direction:{base:"column",md:"row"},gap:4,align:"center",children:[(0,t.jsx)(G.o,{children:(0,t.jsx)(c.a,{p:3,bg:"white",borderRadius:"lg",boxShadow:"md",border:"1px solid",borderColor:"gray.200",children:(0,t.jsx)(H._,{src:R,alt:"文件下载二维码",width:"160px",height:"160px"})})}),(0,t.jsxs)(g.T,{align:"start",spacing:2,flex:"1",children:[(0,t.jsx)(p.E,{fontSize:"sm",color:"gray.600",children:"\uD83D\uDD0D 使用手机扫描二维码即可直接下载文件"}),(0,t.jsx)(p.E,{fontSize:"xs",color:"gray.500",children:"支持微信、支付宝、浏览器等扫码工具"}),(0,t.jsx)(u.$,{size:"sm",variant:"outline",colorScheme:"blue",leftIcon:(0,t.jsx)(Q.s,{}),onClick:()=>{if(!R||!i)return;let e=document.createElement("a");e.download="".concat(i.original_filename,"_qrcode.png"),e.href=R,document.body.appendChild(e),e.click(),document.body.removeChild(e),en({title:"二维码已下载",description:"二维码图片已保存到本地",status:"success",duration:2e3,isClosable:!0})},children:"下载二维码"})]})]})]}),(0,t.jsxs)(c.a,{p:3,bg:"blue.50",borderRadius:"md",children:[(0,t.jsxs)(x.z,{justify:"space-between",children:[(0,t.jsx)(p.E,{fontSize:"sm",color:"blue.700",children:"过期时间:"}),(0,t.jsx)(p.E,{fontSize:"sm",fontWeight:"medium",color:C?"green.600":"blue.700",children:((e,n)=>{if(n)return"永不过期";if(!e)return"";try{return new Date(e).toLocaleString("zh-CN",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit"})}catch(n){return e}})(y,C)})]}),!C&&y&&(0,t.jsx)(p.E,{fontSize:"xs",color:"blue.600",mt:1,children:"链接将在上述时间后失效，需要重新生成"})]}),(0,t.jsx)(q.c,{}),(0,t.jsxs)(c.a,{children:[(0,t.jsx)(p.E,{fontSize:"sm",color:"gray.600",mb:2,children:"需要修改过期时间？"}),(0,t.jsx)(u.$,{size:"sm",variant:"outline",colorScheme:"blue",onClick:es,children:"重新设置过期时间"})]})]}):(0,t.jsxs)(t.Fragment,{children:[(0,t.jsxs)(c.a,{children:[(0,t.jsx)(p.E,{mb:3,fontWeight:"medium",children:"选择链接过期时间"}),(0,t.jsx)(W.z,{value:o,onChange:r,children:(0,t.jsx)(O.B,{spacing:3,children:ee.map(e=>(0,t.jsx)(x.z,{spacing:3,children:(0,t.jsx)(B.s,{value:e.value,colorScheme:"blue",children:(0,t.jsx)(p.E,{fontWeight:"medium",children:e.label})})},e.value))})})]}),"0"===o&&(0,t.jsxs)(A.F,{status:"warning",borderRadius:"md",children:[(0,t.jsx)(K._,{}),(0,t.jsxs)(c.a,{children:[(0,t.jsx)(p.E,{fontWeight:"medium",children:"注意"}),(0,t.jsx)(p.E,{fontSize:"sm",children:"永不过期的链接将长期有效，请确保只与信任的人分享，避免数据泄露风险。"})]})]})]})]})}),(0,t.jsx)(L.j,{children:(0,t.jsxs)(x.z,{spacing:3,children:[(0,t.jsx)(u.$,{variant:"ghost",onClick:s,children:"取消"}),w?(0,t.jsx)(u.$,{colorScheme:"green",onClick:et,children:$?"已复制":"复制链接"}):(0,t.jsx)(u.$,{colorScheme:"blue",onClick:ei,isLoading:b,loadingText:"生成中...",disabled:!i,children:"生成分享链接"})]})})]})]})};function es(){let e=(0,i._)(["\n  .resizable-table {\n    table-layout: fixed;\n    border-collapse: collapse;\n    width: 100%;\n  }\n\n  .resizable-column {\n    position: relative;\n    background-clip: padding-box;\n  }\n\n  .resizable-column:after {\n    content: '';\n    position: absolute;\n    right: 0;\n    top: 0;\n    bottom: 0;\n    width: 5px;\n    cursor: col-resize;\n    background-color: transparent;\n  }\n\n  .resizable-column:hover:after {\n    background-color: #ddd;\n  }\n\n  th.resizable-column {\n    overflow: hidden;\n    white-space: nowrap;\n    text-overflow: ellipsis;\n  }\n\n  td {\n    overflow: hidden;\n    white-space: nowrap;\n    text-overflow: ellipsis;\n  }\n"]);return es=function(){return e},e}let ei=(0,$.AH)(es()),et=e=>e<1024?"".concat(e," B"):e<1048576?"".concat((e/1024).toFixed(2)," KB"):e<0x40000000?"".concat((e/1048576).toFixed(2)," MB"):"".concat((e/0x40000000).toFixed(2)," GB"),el=e=>new Date(e).toLocaleString("zh-CN",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"});function ea(){let[e,n]=(0,l.useState)([]),[s,i]=(0,l.useState)(!0),[$,U]=(0,l.useState)([]),[W,O]=(0,l.useState)(""),[B,A]=(0,l.useState)({page:1,page_size:20,storage_type:""}),[K,P]=(0,l.useState)({key:"created_at",direction:"desc"}),[X,G]=(0,l.useState)(0),H=(0,a.d)(),{isOpen:q,onOpen:Z,onClose:J}=(0,o.j)(),[Q,V]=(0,l.useState)(null),[Y,ee]=(0,l.useState)({checkbox:50,filename:200,size:100,bucket:160,storagePath:200,storageType:120,createdAt:160,actions:140}),[es,ea]=(0,l.useState)([]),[eo,er]=(0,l.useState)(!0),ec=(0,l.useMemo)(()=>{let n=W?e.filter(e=>decodeURIComponent(e.original_filename).toLowerCase().includes(W.toLowerCase())):e;return""===K.key?n:[...n].sort((e,n)=>{if(void 0===e[K.key]||void 0===n[K.key])return 0;let s=e[K.key],i=n[K.key];return"string"==typeof s&&"string"==typeof i?"asc"===K.direction?s.localeCompare(i):i.localeCompare(s):"number"==typeof s&&"number"==typeof i?"asc"===K.direction?s-i:i-s:0})},[e,W,K]),ed=(0,l.useMemo)(()=>{let e=(B.page-1)*B.page_size,n=e+B.page_size;return ec.slice(e,n)},[ec,B.page,B.page_size]);(0,l.useEffect)(()=>{eh(),I.A.get("/user/current").then(e=>{ea(e.data.permissions||[])}).finally(()=>er(!1))},[]);let eh=async()=>{try{i(!0);let e=await M.z.getFiles({page:1,page_size:1e3});e&&(n(e.items||[]),G(e.total||0))}catch(e){console.error("获取文件列表失败",e),H({title:"获取文件列表失败",description:e instanceof Error?e.message:"未知错误",status:"error",duration:3e3,isClosable:!0})}finally{i(!1)}},eu=async n=>{try{let s=await M.z.getFileDownloadURL(n);if(s&&s.download_url){let i=s.download_url;i.startsWith("http://")&&(i=i.replace("http://","https://"));let t=e.find(e=>e.id===n),l=t?decodeURIComponent(t.original_filename):"file_".concat(n);try{let e="".concat(i,"&download=1&t=").concat(Date.now()),n=await fetch(e,{method:"GET",headers:{"Cache-Control":"no-cache"}});if(!n.ok)throw Error("下载失败: ".concat(n.status));let s=await n.blob(),t=window.URL.createObjectURL(s),a=document.createElement("a");a.href=t,a.download=l,a.style.display="none",document.body.appendChild(a),a.click(),document.body.removeChild(a),window.URL.revokeObjectURL(t),H({title:"下载成功",description:'文件 "'.concat(l,'" 已开始下载'),status:"success",duration:3e3,isClosable:!0})}catch(n){console.warn("Blob下载失败，尝试直接下载:",n);let e=document.createElement("a");e.href=i,e.download=l,e.rel="noopener noreferrer",e.style.display="none",document.body.appendChild(e),e.click(),document.body.removeChild(e),H({title:"文件下载中",description:"如果下载没有自动开始，请检查浏览器是否阻止了弹出窗口",status:"info",duration:5e3,isClosable:!0})}}}catch(e){console.error("获取下载链接失败",e),H({title:"获取下载链接失败",description:e instanceof Error?e.message:"未知错误",status:"error",duration:3e3,isClosable:!0})}},ex=e=>{V(e),Z()},em=async()=>{if(null!==Q)try{await M.z.deleteFile(Q),H({title:"文件已删除",status:"success",duration:3e3,isClosable:!0}),eh()}catch(e){console.error("删除文件失败",e),H({title:"删除文件失败",description:e instanceof Error?e.message:"未知错误",status:"error",duration:3e3,isClosable:!0})}finally{V(null),J()}},[ej,eg]=(0,l.useState)(null),[ep,eb]=(0,l.useState)(!1),ef=e=>{eg(e),eb(!0)},ew=async e=>{A({...B,page:1,page_size:Number(e.target.value)}),await eh()},ez=e=>{P(n=>({key:e,direction:n.key===e&&"asc"===n.direction?"desc":"asc"}))},ey=e=>{$.includes(e)?U($.filter(n=>n!==e)):U([...$,e])},ev=async()=>{await eh()},eC=e=>{A(n=>({...n,page:e}))},ek=(e,n)=>{let s=n.pageX,i=Y[e],t=n=>{let t=Math.max(50,i+(n.pageX-s));ee(n=>({...n,[e]:t}))},l=()=>{document.removeEventListener("mousemove",t),document.removeEventListener("mouseup",l)};document.addEventListener("mousemove",t),document.addEventListener("mouseup",l)},eE=(0,l.useMemo)(()=>es.some(e=>"FILE"===e.resource&&"DELETE"===e.action),[es]);return eo?(0,t.jsx)("div",{children:"加载中..."}):(0,t.jsxs)(r.m,{maxW:"container.xl",py:10,children:[(0,t.jsxs)(c.a,{mb:6,children:[(0,t.jsxs)(d.s,{justify:"space-between",align:"center",mb:4,children:[(0,t.jsx)(h.D,{size:"lg",children:"文件列表"}),(0,t.jsx)(u.$,{leftIcon:(0,t.jsx)(R.jTZ,{}),onClick:ev,isLoading:s,children:"刷新"})]}),(0,t.jsxs)(x.z,{spacing:4,mb:6,children:[(0,t.jsx)(m.p,{placeholder:"搜索文件名",value:W,onChange:e=>{O(e.target.value),A(e=>({...e,page:1}))},maxW:"300px"}),(0,t.jsx)(u.$,{leftIcon:(0,t.jsx)(R.CKj,{}),onClick:()=>{A(e=>({...e,page:1}))},children:"搜索"}),$.length>0&&(0,t.jsxs)(u.$,{colorScheme:"red",leftIcon:(0,t.jsx)(R.IXo,{}),onClick:()=>{0!==$.length&&H({title:"批量删除暂未实现",description:"请使用单个删除功能",status:"info",duration:3e3,isClosable:!0})},children:["批量删除 (",$.length,")"]})]}),s?(0,t.jsx)(d.s,{justify:"center",align:"center",minH:"200px",children:(0,t.jsx)(j.y,{size:"xl"})}):(0,t.jsx)(t.Fragment,{children:0===e.length?(0,t.jsx)(g.T,{py:10,children:(0,t.jsx)(p.E,{color:"gray.500",children:"暂无文件"})}):(0,t.jsxs)(c.a,{overflowX:"auto",css:ei,children:[(0,t.jsxs)(b.X,{variant:"simple",className:"resizable-table",children:[(0,t.jsx)(f.d,{children:(0,t.jsxs)(w.Tr,{children:[(0,t.jsx)(z.Th,{px:2,className:"resizable-column",width:"".concat(Y.checkbox,"px"),onMouseDown:e=>ek("checkbox",e.nativeEvent),children:(0,t.jsx)(y.S,{isChecked:$.length===e.length&&e.length>0,onChange:()=>{$.length===e.length?U([]):U(e.map(e=>e.id))}})}),(0,t.jsx)(z.Th,{cursor:"pointer",className:"resizable-column",width:"".concat(Y.filename,"px"),onMouseDown:e=>ek("filename",e.nativeEvent),onClick:()=>ez("original_filename"),children:(0,t.jsxs)(d.s,{align:"center",children:["文件名","original_filename"===K.key&&(0,t.jsx)(p.E,{ml:1,fontSize:"xs",children:"asc"===K.direction?"↑":"↓"})]})}),(0,t.jsx)(z.Th,{className:"resizable-column",width:"".concat(Y.bucket,"px"),onMouseDown:e=>ek("bucket",e.nativeEvent),children:"用户名称"}),(0,t.jsx)(z.Th,{className:"resizable-column",width:"".concat(Y.storagePath,"px"),onMouseDown:e=>ek("storagePath",e.nativeEvent),children:"存储路径"}),(0,t.jsx)(z.Th,{cursor:"pointer",className:"resizable-column",width:"".concat(Y.size,"px"),onMouseDown:e=>ek("size",e.nativeEvent),onClick:()=>ez("file_size"),children:(0,t.jsxs)(d.s,{align:"center",children:["大小","file_size"===K.key&&(0,t.jsx)(p.E,{ml:1,fontSize:"xs",children:"asc"===K.direction?"↑":"↓"})]})}),(0,t.jsx)(z.Th,{cursor:"pointer",className:"resizable-column",width:"".concat(Y.createdAt,"px"),onMouseDown:e=>ek("createdAt",e.nativeEvent),onClick:()=>ez("created_at"),children:(0,t.jsxs)(d.s,{align:"center",children:["上传时间","created_at"===K.key&&(0,t.jsx)(p.E,{ml:1,fontSize:"xs",children:"asc"===K.direction?"↑":"↓"})]})}),(0,t.jsx)(z.Th,{className:"resizable-column",width:"".concat(Y.actions,"px"),onMouseDown:e=>ek("actions",e.nativeEvent),children:"操作"})]})}),(0,t.jsx)(v.N,{children:ed.map(e=>{let n=e.object_key?e.object_key.split("/"):[],s=n.length>0?n[0]:e.config_name||"-",i=n.length>1?n.slice(0,-1).join("/"):e.object_key||"-";return(0,t.jsxs)(w.Tr,{children:[(0,t.jsx)(C.Td,{px:2,className:"resizable-column",width:"".concat(Y.checkbox,"px"),children:(0,t.jsx)(y.S,{isChecked:$.includes(e.id),onChange:()=>ey(e.id)})}),(0,t.jsx)(C.Td,{className:"resizable-column",width:"".concat(Y.filename,"px"),children:decodeURIComponent(e.original_filename)}),(0,t.jsx)(C.Td,{className:"resizable-column",width:"".concat(Y.bucket,"px"),children:s}),(0,t.jsx)(C.Td,{className:"resizable-column",width:"".concat(Y.storagePath,"px"),children:i}),(0,t.jsx)(C.Td,{className:"resizable-column",width:"".concat(Y.size,"px"),children:et(e.file_size)}),(0,t.jsx)(C.Td,{className:"resizable-column",width:"".concat(Y.createdAt,"px"),children:el(e.created_at)}),(0,t.jsx)(C.Td,{className:"resizable-column",width:"".concat(Y.actions,"px"),children:(0,t.jsxs)(x.z,{spacing:2,justify:"flex-start",overflow:"visible",children:[(0,t.jsx)(k.K,{"aria-label":"下载文件",icon:(0,t.jsx)(R.a4x,{}),size:"sm",onClick:()=>eu(e.id)}),(0,t.jsx)(k.K,{"aria-label":"分享链接",icon:(0,t.jsx)(R.Pum,{}),size:"sm",colorScheme:"blue",onClick:()=>ef(e)}),eE&&(0,t.jsx)(k.K,{"aria-label":"删除文件",icon:(0,t.jsx)(R.IXo,{}),size:"sm",colorScheme:"red",onClick:()=>ex(e.id),zIndex:1})]})})]},e.id)})})]}),(0,t.jsxs)(d.s,{justify:"space-between",mt:4,children:[(0,t.jsxs)(x.z,{children:[(0,t.jsxs)(p.E,{children:["每页 ",B.page_size," 条"]}),(0,t.jsx)(p.E,{mx:2,children:"|"}),(0,t.jsxs)(p.E,{children:["第 ",B.page," 页"]}),(0,t.jsx)(p.E,{mx:2,children:"|"}),(0,t.jsxs)(p.E,{children:["共 ",ec.length," 条记录"]}),(0,t.jsxs)(E.l,{value:B.page_size,onChange:ew,size:"sm",width:"100px",ml:4,children:[(0,t.jsx)("option",{value:10,children:"10条/页"}),(0,t.jsx)("option",{value:20,children:"20条/页"}),(0,t.jsx)("option",{value:50,children:"50条/页"}),(0,t.jsx)("option",{value:100,children:"100条/页"})]})]}),(0,t.jsxs)(x.z,{children:[(0,t.jsx)(u.$,{onClick:()=>eC(B.page-1),isDisabled:1===B.page||s,children:"上一页"}),(0,t.jsxs)(p.E,{children:["第 ",B.page," 页"]}),(0,t.jsx)(u.$,{onClick:()=>eC(B.page+1),isDisabled:B.page*B.page_size>=ec.length||s,children:"下一页"})]})]})]})})]}),(0,t.jsxs)(S.aF,{isOpen:q,onClose:J,children:[(0,t.jsx)(_.m,{}),(0,t.jsxs)(T.$,{children:[(0,t.jsx)(D.r,{children:"确认删除"}),(0,t.jsx)(N.s,{}),(0,t.jsx)(F.c,{children:"您确定要删除选中的文件吗？此操作无法撤销。"}),(0,t.jsxs)(L.j,{children:[(0,t.jsx)(u.$,{variant:"ghost",mr:3,onClick:J,children:"取消"}),(0,t.jsx)(u.$,{colorScheme:"red",onClick:em,children:"确认删除"})]})]})]}),(0,t.jsx)(en,{isOpen:ep,onClose:()=>{eb(!1),eg(null)},file:ej})]})}},90056:(e,n,s)=>{Promise.resolve().then(s.bind(s,9387))}},e=>{var n=n=>e(e.s=n);e.O(0,[844,8791,6829,6980,7039,2210,3464,3513,8277,5030,9233,4509,8441,1684,7358],()=>n(90056)),_N_E=e.O()}]);